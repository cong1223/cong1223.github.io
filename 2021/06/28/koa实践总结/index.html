<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="å°èªå¿™"><meta name="copyright" content="å°èªå¿™"><meta name="generator" content="Hexo 5.3.0"><meta name="theme" content="hexo-theme-yun"><title>koaå®è·µæ€»ç»“ | èªå¿™çš„å°ç«™-Code &amp; Rock</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.1.22/dist/yun/yun-markdown.min.css"><script src="//at.alicdn.com/t/font_1140697_ed8vp4atwoj.js" async></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>document.addEventListener("DOMContentLoaded", () => {
  [".post-card",".post-content img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
});
</script><link rel="shortcut icon" type="image/svg+xml" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#0078E7"><link rel="alternate icon" href="/yun.ico"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><script id="yun-config">
    const Yun = window.Yun || {};
    window.CONFIG = {"hostname":"cong1223.github.io","root":"/","title":"èªå¿™çš„å°ç«™","version":"1.4.0","mode":"auto","copycode":true,"page":{"isPost":true},"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","say":{"api":"https://el-bot-api.vercel.app/api/words/young"},"algolia":{"appID":"FPFBIG0SN1","apiKey":"f75714621d5494f13edbe7a616932224","indexName":"hexo-blog","hits":{"per_page":8},"labels":{"input_placeholder":"æœç´¢æ–‡ç« ","hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹: ${query}","hits_stats":"æ‰¾åˆ° ${hits} æ¡ç»“æœï¼Œç”¨æ—¶ ${time} æ¯«ç§’"}},"fireworks":{"colors":["102, 167, 221","62, 131, 225","33, 78, 194"]}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/utils.js"></script><script src="/js/hexo-theme-yun.js"></script><script>(function(){
  var bp = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https') {
    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else {
    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})();</script><!-- Google Tag Manager --><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-M9KWR9L');</script><!-- End Google Tag Manager --><meta name="description" content="ä»€ä¹ˆæ˜¯koaï¼Ÿkoaæ˜¯Expressçš„ä¸‹ä¸€ä»£åŸºäºNode.jsçš„webæ¡†æ¶ã€‚ä½¿ç”¨ koa ç¼–å†™ web åº”ç”¨ï¼Œé€šè¿‡ç»„åˆä¸åŒçš„ generatorï¼Œå¯ä»¥å…é™¤é‡å¤ç¹ççš„å›è°ƒå‡½æ•°åµŒå¥—ï¼Œå¹¶æå¤§åœ°æå‡å¸¸ç”¨é”™è¯¯å¤„ç†æ•ˆç‡ã€‚Koa ä¸åœ¨å†…æ ¸æ–¹æ³•ä¸­ç»‘å®šä»»ä½•ä¸­é—´ä»¶ï¼Œå®ƒä»…ä»…æä¾›äº†ä¸€ä¸ªè½»é‡ä¼˜é›…çš„å‡½æ•°åº“ï¼Œä½¿å¾—ç¼–å†™ Web åº”ç”¨å’ŒAPIå˜å¾—å¾—å¿ƒåº”æ‰‹ã€‚ Koaèƒ½å¹²ä»€ä¹ˆï¼Ÿä¸»è¦ç”¨é€”  ç½‘ç«™ï¼ˆæ¯”å¦‚cnodeè¿™æ ·çš„è®ºå›ï¼‰ apiï¼ˆä¸‰ç«¯">
<meta property="og:type" content="article">
<meta property="og:title" content="koaå®è·µæ€»ç»“">
<meta property="og:url" content="https://cong1223.github.io/2021/06/28/koa%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93/index.html">
<meta property="og:site_name" content="èªå¿™çš„å°ç«™-Code &amp; Rock">
<meta property="og:description" content="ä»€ä¹ˆæ˜¯koaï¼Ÿkoaæ˜¯Expressçš„ä¸‹ä¸€ä»£åŸºäºNode.jsçš„webæ¡†æ¶ã€‚ä½¿ç”¨ koa ç¼–å†™ web åº”ç”¨ï¼Œé€šè¿‡ç»„åˆä¸åŒçš„ generatorï¼Œå¯ä»¥å…é™¤é‡å¤ç¹ççš„å›è°ƒå‡½æ•°åµŒå¥—ï¼Œå¹¶æå¤§åœ°æå‡å¸¸ç”¨é”™è¯¯å¤„ç†æ•ˆç‡ã€‚Koa ä¸åœ¨å†…æ ¸æ–¹æ³•ä¸­ç»‘å®šä»»ä½•ä¸­é—´ä»¶ï¼Œå®ƒä»…ä»…æä¾›äº†ä¸€ä¸ªè½»é‡ä¼˜é›…çš„å‡½æ•°åº“ï¼Œä½¿å¾—ç¼–å†™ Web åº”ç”¨å’ŒAPIå˜å¾—å¾—å¿ƒåº”æ‰‹ã€‚ Koaèƒ½å¹²ä»€ä¹ˆï¼Ÿä¸»è¦ç”¨é€”  ç½‘ç«™ï¼ˆæ¯”å¦‚cnodeè¿™æ ·çš„è®ºå›ï¼‰ apiï¼ˆä¸‰ç«¯">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627083559.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627084008.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627085327.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627090757.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627092430.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627093721.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627102934.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627102601.png">
<meta property="og:image" content="https://cong1223.github.io/Users/mac/Library/Application%20Support/typora-user-images/image-20210627102758998.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627163251.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627163452.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627164257.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627164506.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627164652.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627171126.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627173550.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627173801.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210628073806.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210628073853.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210628082630.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627174730.png">
<meta property="article:published_time" content="2021-06-28T15:18:32.000Z">
<meta property="article:modified_time" content="2021-07-16T23:50:55.017Z">
<meta property="article:author" content="å°èªå¿™">
<meta property="article:tag" content="koa2">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627083559.png"><script src="/js/ui/mode.js"></script></head><body><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="æ–‡ç« ç›®å½•"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="ç«™ç‚¹æ¦‚è§ˆ"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="å°èªå¿™"><img width="96" loading="lazy" src="/images/ghostwang.jpeg" alt="å°èªå¿™"><span class="site-author-status" title="Looking for dawn.">ğŸŒ‘</span></a><div class="site-author-name"><a href="/about/">å°èªå¿™</a></div><a class="site-name" href="/about/site.html">èªå¿™çš„å°ç«™-Code &amp; Rock</a><sub class="site-subtitle">è®°å½•åˆ†äº«å‰ç«¯é¢†åŸŸæŠ€æœ¯åšæ–‡</sub><div class="site-desciption"></div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="é¦–é¡µ"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="å½’æ¡£"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">56</span></a></div><div class="site-state-item"><a href="/categories/" title="åˆ†ç±»"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">14</span></a></div><div class="site-state-item"><a href="/tags/" title="æ ‡ç­¾"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">60</span></a></div><a class="site-state-item hty-icon-button" href="/about/#comment" title="ç•™è¨€æ¿"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-clipboard-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="/atom.xml" title="RSS" target="_blank" style="color:orange"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-rss-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://jq.qq.com/?_wv=1027&amp;k=g4dnBzs9" title="QQ ç¾¤ 94500464" target="_blank" style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/cong1223" title="GitHub" target="_blank" style="color:#6e5494"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://weibo.com/5861177611" title="å¾®åš" target="_blank" style="color:#E6162D"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-weibo-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://music.163.com/#/user/home?id=436106908" title="ç½‘æ˜“äº‘éŸ³ä¹" target="_blank" style="color:#C20C0C"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-netease-cloud-music-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://space.bilibili.com/94308826" title="å“”å“©å“”å“©" target="_blank" style="color:#FF8EB3"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-bilibili-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210131133736.png" title="å¾®ä¿¡å…¬ä¼—å·" target="_blank" style="color:#1AAD19"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-2-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="mailto:1215524451@qq.com" title="E-Mail" target="_blank" style="color:#8E71C1"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="æˆ‘çš„å°ä¼™ä¼´ä»¬" style="color:dodgerblue"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-genderless-line"></use></svg></a><a class="links-item hty-icon-button" href="/girls/" title="å–œæ¬¢çš„å¥³å­©å­" style="color:hotpink"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-women-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-contrast-2-line"></use></svg></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFkoa%EF%BC%9F"><span class="toc-number">1.</span> <span class="toc-text">ä»€ä¹ˆæ˜¯koaï¼Ÿ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Koa%E8%83%BD%E5%B9%B2%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">2.</span> <span class="toc-text">Koaèƒ½å¹²ä»€ä¹ˆï¼Ÿ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA%E9%A1%B9%E7%9B%AE%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1"><span class="toc-number">3.</span> <span class="toc-text">æ­å»ºé¡¹ç›®å¯åŠ¨æœåŠ¡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E5%A4%84%E7%90%86"><span class="toc-number">4.</span> <span class="toc-text">è·¯ç”±å¤„ç†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90"><span class="toc-number">5.</span> <span class="toc-text">å‚æ•°è§£æ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%9F%E4%B8%80%E5%93%8D%E5%BA%94%E4%BD%93-amp-%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="toc-number">6.</span> <span class="toc-text">ç»Ÿä¸€å“åº”ä½“ &amp; é”™è¯¯å¤„ç†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E6%A0%A1%E9%AA%8C"><span class="toc-number">7.</span> <span class="toc-text">å‚æ•°æ ¡éªŒ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%B7%A8%E5%9F%9F"><span class="toc-number">8.</span> <span class="toc-text">é…ç½®è·¨åŸŸ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A5%E5%BF%97"><span class="toc-number">9.</span> <span class="toc-text">æ—¥å¿—</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C"><span class="toc-number">10.</span> <span class="toc-text">æ•°æ®åº“æ“ä½œ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">11.</span> <span class="toc-text">æ€»ç»“</span></a></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="post-block" itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://cong1223.github.io/2021/06/28/koa%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="å°èªå¿™"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="èªå¿™çš„å°ç«™-Code &amp; Rock"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">koaå®è·µæ€»ç»“</h1><div class="post-meta"><div class="post-time" style="display:block"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <time title="åˆ›å»ºæ—¶é—´ï¼š2021-06-28 23:18:32" itemprop="dateCreated datePublished" datetime="2021-06-28T23:18:32+08:00">2021-06-28</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-2-line"></use></svg></span> <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-07-17 07:50:55" itemprop="dateModified" datetime="2021-07-17T07:50:55+08:00">2021-07-17</time></div><span class="post-count"><span class="post-symbolcount"><span class="post-meta-item-icon" title="æœ¬æ–‡å­—æ•°"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-file-word-line"></use></svg></span> <span title="æœ¬æ–‡å­—æ•°">5.1k</span><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="é˜…è¯»æ—¶é•¿"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-timer-line"></use></svg></span> <span title="é˜…è¯»æ—¶é•¿">23m</span></span></span><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-line"></use></svg></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category" href="/categories/koa2/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">koa2</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag" href="/tags/koa2/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">koa2</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body" style="--smc-primary:#0078E7;"><h3 id="ä»€ä¹ˆæ˜¯koaï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯koaï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯koaï¼Ÿ"></a>ä»€ä¹ˆæ˜¯koaï¼Ÿ</h3><p>koaæ˜¯Expressçš„ä¸‹ä¸€ä»£åŸºäºNode.jsçš„webæ¡†æ¶ã€‚ä½¿ç”¨ koa ç¼–å†™ web åº”ç”¨ï¼Œé€šè¿‡ç»„åˆä¸åŒçš„ generatorï¼Œå¯ä»¥å…é™¤é‡å¤ç¹ççš„å›è°ƒå‡½æ•°åµŒå¥—ï¼Œå¹¶æå¤§åœ°æå‡å¸¸ç”¨é”™è¯¯å¤„ç†æ•ˆç‡ã€‚Koa ä¸åœ¨å†…æ ¸æ–¹æ³•ä¸­ç»‘å®šä»»ä½•ä¸­é—´ä»¶ï¼Œå®ƒä»…ä»…æä¾›äº†ä¸€ä¸ªè½»é‡ä¼˜é›…çš„å‡½æ•°åº“ï¼Œä½¿å¾—ç¼–å†™ Web åº”ç”¨å’ŒAPIå˜å¾—å¾—å¿ƒåº”æ‰‹ã€‚</p>
<h3 id="Koaèƒ½å¹²ä»€ä¹ˆï¼Ÿ"><a href="#Koaèƒ½å¹²ä»€ä¹ˆï¼Ÿ" class="headerlink" title="Koaèƒ½å¹²ä»€ä¹ˆï¼Ÿ"></a>Koaèƒ½å¹²ä»€ä¹ˆï¼Ÿ</h3><p>ä¸»è¦ç”¨é€”</p>
<ul>
<li>ç½‘ç«™ï¼ˆæ¯”å¦‚cnodeè¿™æ ·çš„è®ºå›ï¼‰</li>
<li>apiï¼ˆä¸‰ç«¯ï¼špcã€ç§»åŠ¨ç«¯ã€h5ï¼‰</li>
<li>ä¸å…¶ä»–æ¨¡å—æ­é…ï¼Œæ¯”å¦‚å’Œsocket.ioæ­é…å†™å¼¹å¹•ã€imï¼ˆå³æ—¶èŠå¤©ï¼‰ç­‰</li>
</ul>
<p>koaæ˜¯å¾®å‹webæ¡†æ¶ï¼Œä½†å®ƒä¹Ÿæ˜¯ä¸ªNode.jsæ¨¡å—ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ©ç”¨å®ƒåšä¸€äº›httpç›¸å…³çš„äº‹å„¿ã€‚ä¸¾ä¾‹ï¼šå®ç°ç±»ä¼¼äºhttp-serverè¿™æ ·çš„åŠŸèƒ½ï¼Œåœ¨vueæˆ–reactå¼€å‘é‡Œï¼Œåœ¨çˆ¬è™«é‡Œï¼Œåˆ©ç”¨è·¯ç”±è§¦å‘çˆ¬è™«ä»»åŠ¡ç­‰ã€‚æ¯”å¦‚åœ¨binæ¨¡å—é‡Œï¼Œé›†æˆkoaæ¨¡å—ï¼Œå¯åŠ¨ä¸ªstatic-http-serverè¿™æ ·çš„åŠŸèƒ½ï¼Œéƒ½æ˜¯éå¸¸å®¹æ˜“çš„ã€‚</p>
<h3 id="æ­å»ºé¡¹ç›®å¯åŠ¨æœåŠ¡"><a href="#æ­å»ºé¡¹ç›®å¯åŠ¨æœåŠ¡" class="headerlink" title="æ­å»ºé¡¹ç›®å¯åŠ¨æœåŠ¡"></a>æ­å»ºé¡¹ç›®å¯åŠ¨æœåŠ¡</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. åˆ›å»ºé¡¹ç›®æ–‡ä»¶å¤¹ååˆå§‹åŒ–npm</span></span><br><span class="line">npm init</span><br><span class="line"><span class="comment">// 2. å®‰è£…koaç¯å¢ƒ</span></span><br><span class="line">npm install koa</span><br><span class="line"><span class="comment">// 3. æ ¹ç›®å½•ä¸‹åˆ›å»ºappæ–‡ä»¶å¤¹ä½œä¸ºæˆ‘ä»¬æºä»£ç çš„ç›®å½•</span></span><br><span class="line"><span class="comment">// 4. appä¸‹æ–°å»ºindex.jsä½œä¸ºå…¥å£æ–‡ä»¶</span></span><br></pre></td></tr></table></figure>
<p>ç”Ÿæˆç›®å½•ç»“æ„å¦‚ä¸‹ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627083559.png" loading="lazy"></p>
<p>ç¼–å†™<code>app/index.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"><span class="keyword">const</span> port = <span class="string">&#x27;3333&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> host = <span class="string">&#x27;0.0.0.0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  ctx.body = <span class="string">&#x27;Hello World&#x27;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(port, host, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`API server listening on <span class="subst">$&#123;host&#125;</span>:<span class="subst">$&#123;port&#125;</span>`</span>)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>æ ¹ç›®å½•ä¸‹è¿è¡Œ<code>node app/index.js</code>ï¼Œå¯åŠ¨æˆåŠŸåæ§åˆ¶å°å‡ºç°<code>API server listening on 0.0.0.0:3333</code>ï¼Œæ‰“å¼€æµè§ˆå™¨è®¿é—®<code>æœ¬æœºip:3333</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627084008.png" alt="image-20210627084008790" loading="lazy"></p>
<h3 id="è·¯ç”±å¤„ç†"><a href="#è·¯ç”±å¤„ç†" class="headerlink" title="è·¯ç”±å¤„ç†"></a>è·¯ç”±å¤„ç†</h3><p><code>koa</code>ä¸­å¤„ç†ç›¸åº”çš„è·¯ç”±è¿”å›å¯¹åº”çš„å“åº”è¿™ä¸€å¼€å‘è¿‡ç¨‹ç±»ä¼¼<code>java</code>ä¸­ç¼–å†™<code>controller</code>ï¼Œ<code>restful</code>é£æ ¼çš„è·¯ç”±å¯ä»¥éå¸¸è¯­ä¹‰åŒ–çš„æ ¹æ®ä¸šåŠ¡åœºæ™¯ç¼–å†™å¯¹åº”çš„å¤„ç†å‡½æ•°ï¼Œå‰ç«¯åˆ©ç”¨<code>axios</code>è®¿é—®æœåŠ¡ç«¯æ‰¾åˆ°å¯¹åº”çš„å‡½æ•°ï¼ˆè·¯ç”±åå­—ï¼‰æ¥è·å–å¯¹åº”æƒ³è¦çš„ç»“æœã€‚</p>
<p>ç¼–å†™<code>app/index.js</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/index.js</span></span><br><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> port = <span class="string">&#x27;3333&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> host = <span class="string">&#x27;0.0.0.0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; path &#125; = ctx;</span><br><span class="line">  <span class="built_in">console</span>.log(path)</span><br><span class="line">  <span class="keyword">if</span> (path === <span class="string">&#x27;/test1&#x27;</span>) &#123;</span><br><span class="line">    ctx.body = <span class="string">&#x27;response for test1&#x27;</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (path === <span class="string">&#x27;/test2&#x27;</span>) &#123;</span><br><span class="line">    ctx.body = <span class="string">&#x27;response for test2&#x27;</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (path === <span class="string">&#x27;/test3&#x27;</span>) &#123;</span><br><span class="line">    ctx.body = <span class="string">&#x27;response for test3&#x27;</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    ctx.body = <span class="string">&#x27;Hello World&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(port, host, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`API server listening on <span class="subst">$&#123;host&#125;</span>:<span class="subst">$&#123;port&#125;</span>`</span>)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>æ³¨æ„ï¼šæ¯æ¬¡åœ¨koaä¸­æ›´æ–°ä»£ç åæƒ³è¦ç”Ÿæ•ˆå¿…é¡»é‡å¯koaæœåŠ¡</strong></p>
<p>è¿™æ—¶ï¼Œæˆ‘ä»¬å†è®¿é—®è¯•è¯•ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627085327.png" alt="image-20210627085327472" loading="lazy"></p>
<p>ç»“æœæŒ‰æˆ‘ä»¬é¢„æœŸè¿”å›äº†ï¼Œè¿™æ—¶æˆ‘ä»¬å…ˆè§£å†³ä¸Šè¯‰çš„é—®é¢˜ï¼Œå¦‚ä½•çƒ­æ›´æ–°ä»£ç æ¥å¸®åŠ©æˆ‘ä»¬æé«˜å¼€å‘æ•ˆç‡</p>
<ol>
<li><p>å®‰è£…<code>nodemon</code></p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install nodemon</span><br><span class="line">npm i nodemon -g // å»ºè®®ç›´æ¥å…¨å±€å®‰è£…</span><br></pre></td></tr></table></figure>


</li>
</ol>
<ol start="2">
<li>ä¿®æ”¹<code>package.js</code></li>
</ol>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;scripts&quot;: &#123;</span><br><span class="line">  &quot;start&quot;: &quot;nodemon app/index.js&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>è¿è¡Œ<code>npm run start</code>å†æ¬¡å¯åŠ¨æœåŠ¡ï¼Œè¿™æ—¶ä¿®æ”¹ä»£ç ååªéœ€è¦åˆ·æ–°æµè§ˆå™¨å³å¯ï¼Œä¸ç”¨é‡å¯nodeæœåŠ¡äº†!</p>
<p>å¯ä»¥é¢„è§çš„æ˜¯ï¼šä¸Šé¢å¯¹è·¯ç”±çš„å¤„ç†åœ¨å®æˆ˜ä¸­æ˜¯ä¸å¯è¡Œçš„ï¼Œapié€æ¸å¢åŠ åéœ€è¦è€ƒè™‘åˆ°ç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§ï¼Œ<code>koa-router</code>åº”è¿è€Œç”Ÿã€‚</p>
<blockquote>
<p>koa-router: é›†ä¸­å¤„ç†URLçš„ä¸­é—´ä»¶ï¼Œå®ƒè´Ÿè´£å¤„ç†URLæ˜ å°„ï¼Œæ ¹æ®ä¸åŒçš„URLè°ƒç”¨ä¸åŒçš„å¤„ç†å‡½æ•°ï¼Œè¿™æ ·ï¼Œæˆ‘ä»¬å°±èƒ½èƒ½ä¸“å¿ƒä¸ºæ¯ä¸ªURLç¼–å†™å¤„ç†å‡½æ•°</p>
</blockquote>
<p>åœ¨ <code>app</code> ç›®å½•ä¸‹æ–°å»º <code>router</code> ç›®å½•ï¼Œå¦‚ä¸‹æ‰€ç¤º:</p>
<p><img src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627090757.png" alt="image-20210627090757106" loading="lazy"></p>
<p>å®‰è£…<code>koa-router</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install koa-router</span><br></pre></td></tr></table></figure>
<p>ç¼–å†™<code>app/router/index.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> koaRouter = <span class="built_in">require</span>(<span class="string">&#x27;koa-router&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> koaRouter();</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">&#x27;/test1&#x27;</span>, <span class="function"><span class="params">ctx</span>  =&gt;</span> &#123;</span><br><span class="line">  ctx.body = <span class="string">&#x27;response for test1&#x27;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">&#x27;/test2&#x27;</span>, <span class="function"><span class="params">ctx</span>  =&gt;</span> &#123;</span><br><span class="line">  ctx.body = <span class="string">&#x27;response for test2&#x27;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">&#x27;/test3&#x27;</span>, <span class="function"><span class="params">ctx</span>  =&gt;</span> &#123;</span><br><span class="line">  ctx.body = <span class="string">&#x27;response for test3&#x27;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>æµè§ˆå™¨ä¸­å†æ¬¡è®¿é—®æµ‹è¯•ï¼Œ<code>http://192.168.0.197:3333/test3</code>ï¼Œè¿”å›<code>response for test3</code>ï¼Œè¿”å›ç»“æœä¸ä¹‹å‰ä¸€è‡´ã€‚å†æ¬¡ç»†æƒ³ä¸€ä¸‹ï¼Œå®é™…å…¬å¸çš„ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œ<code>router/index.js</code>ä¸­å¯èƒ½ä¸€ä¸ªå¤„ç†å‡½æ•°å°±ä¼šéå¸¸åºå¤§ï¼Œå› æ­¤ï¼Œè·¯ç”±æ–‡ä»¶æˆ‘ä»¬åªéœ€è¦å…³å¿ƒå…·ä½“çš„è·¯ç”±ï¼Œå®ƒå¯¹åº”çš„å¤„ç†å‡½æ•°å¯ä»¥å•ç‹¬æå‡ºæ¥ç»Ÿä¸€ç®¡ç†ã€‚æˆ‘ä»¬å¯ä»¥æŠŠä¸šåŠ¡é€»è¾‘å¤„ç†å‡½æ•°æ”¾åˆ°<code>controller</code>ä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627092430.png" alt="image-20210627092430698" loading="lazy"></p>
<p>æˆ‘ä»¬æ–°å¢äº†ä¸‰ä¸ªæ–‡ä»¶ï¼š</p>
<ul>
<li><code>app/router/routes.js</code>    è·¯ç”±åˆ—è¡¨æ–‡ä»¶</li>
<li><code>app/contronllers/index.js</code>  ä¸šåŠ¡å¤„ç†ç»Ÿä¸€å¯¼å‡º</li>
<li><code>app/contronllers/test.js</code>  ä¸šåŠ¡å¤„ç†æ–‡ä»¶</li>
</ul>
<p>æ‰€æœ‰çš„ä¸šåŠ¡é€»è¾‘ä»£ç æ”¾åˆ°controllerä¸­ç®¡ç†ï¼Œå¦‚<code>app/contronllers/test.js</code>æ‰€ç¤ºï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> echo = <span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  ctx.body = <span class="string">&#x27;è¿™æ˜¯ä¸€æ®µæ–‡å­—...&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  echo</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>app/contronllers/index.js</code>ç»Ÿä¸€å…¥å£ï¼Œç®¡ç†å¯¼å‡º</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> test =  <span class="built_in">require</span>(<span class="string">&#x27;./test&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  test</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>app/router/routes.js</code>è·¯ç”±æ–‡ä»¶ä¸“å¿ƒç®¡ç†æ‰€æœ‰è·¯ç”±ï¼Œæ— éœ€ç»´æŠ¤å¯¹åº”ä¸šåŠ¡é€»è¾‘ä»£ç </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; test &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../controllers&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">&#x27;test1&#x27;</span>,</span><br><span class="line">    method: <span class="string">&#x27;get&#x27;</span>,</span><br><span class="line">    controller: test.echo</span><br><span class="line">  &#125;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = routes;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>æ”¹é€ <code>app/router/index.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> koaRouter = <span class="built_in">require</span>(<span class="string">&#x27;koa-router&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> koaRouter();</span><br><span class="line"><span class="keyword">const</span> routes = <span class="built_in">require</span>(<span class="string">&#x27;./routes&#x27;</span>);</span><br><span class="line"></span><br><span class="line">routes.forEach(<span class="function"><span class="params">route</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; method, path, controller &#125; = route;</span><br><span class="line">  <span class="comment">//  router ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ pathï¼Œ åé¢è·Ÿä¸Šè·¯ç”±çº§ä¸­é—´ä»¶ controllerï¼ˆä¸Šé¢ç¼–å†™çš„è·¯ç”±å¤„ç†å‡½æ•°ï¼‰</span></span><br><span class="line">  router[method](path, controller);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure>
<p>æ‰“å¼€æµè§ˆå™¨è®¿é—®<code>http://192.168.0.197:3333/test1</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627093721.png" alt="image-20210627093721213" loading="lazy"></p>
<p>ç»“æœå¦‚é€¾æœŸæ­£å¸¸è¿”å›ï¼Œæµ‹è¯•æˆåŠŸã€‚</p>
<h3 id="å‚æ•°è§£æ"><a href="#å‚æ•°è§£æ" class="headerlink" title="å‚æ•°è§£æ"></a>å‚æ•°è§£æ</h3><p>æµ‹è¯•å®Œgetè¯·æ±‚åå†è¯·æ±‚ä¸€ä¸ªpostè¯·æ±‚ï¼Œpathä¸º<code>/postTest</code>ï¼Œå‚æ•°ä¸º<code>name: wangcong</code>ï¼Œè¯·æ±‚å¦‚ä¸‹ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627102934.png" alt="image-20210627102933947" loading="lazy"></p>
<p>æ‰“å°å‡º<code>console.log(&#39;postTest&#39;, ctx)</code>å¦‚ä¸‹ï¼Œå¥½åƒå¹¶æ²¡æœ‰æ‰¾åˆ°æˆ‘ä»¬ä¼ å…¥çš„å‚æ•°â€™nameâ€™ï¼Œé‚£å¦‚ä½•è·å–åˆ°postçš„è¯·æ±‚ä½“å‘¢ï¼Ÿ</p>
<p><img src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627102601.png" alt="image-20210627102601854" loading="lazy"></p>
<p><code>koa-bodyparser</code>: å¯¹äºPOSTè¯·æ±‚çš„å¤„ç†ï¼Œkoa-bodyparserä¸­é—´ä»¶å¯ä»¥æŠŠkoa2ä¸Šä¸‹æ–‡çš„formDataæ•°æ®è§£æåˆ°ctx.request.bodyä¸­</p>
<p>å®‰è£…ä¸­é—´ä»¶ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ç…§æ”¹é€ routerçš„æ–¹å¼æ”¹é€ ä¸€ä¸‹ä¸­é—´ä»¶çš„ç®¡ç†</p>
<p>æ–°å»º<code>app/midllewares</code>ç›®å½•ï¼Œæ·»åŠ <code>index.js</code>æ–‡ä»¶ç»Ÿä¸€ç®¡ç†æ‰€æœ‰ä¸­é—´ä»¶</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">&#x27;../router&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·¯ç”±å¤„ç†,router.allowedMethods()ç”¨åœ¨äº†è·¯ç”±åŒ¹é…router.routes()ä¹‹å,æ‰€ä»¥åœ¨å½“æ‰€æœ‰è·¯ç”±ä¸­é—´ä»¶æœ€åè°ƒç”¨.æ­¤æ—¶æ ¹æ®ctx.statusè®¾ç½®responseå“åº”å¤´</span></span><br><span class="line"><span class="keyword">const</span> mdRoute = router.routes();</span><br><span class="line"><span class="keyword">const</span> mdRouterAllowed = router.allowedMethods();</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯¼å‡ºæ•°ç»„æ˜¯ä¸ºåé¢ä½¿ç”¨koa-composeåšå‡†å¤‡ï¼Œkoa-composeæ”¯æŒä¼ å…¥æ•°ç»„ï¼Œæ•°ç»„é‡Œçš„ä¸­é—´ä»¶ä¸€æ¬¡åŒæ­¥æ‰§è¡Œ</span></span><br><span class="line"><span class="comment">// æ´‹è‘±æ¨¡å‹, åŠ¡å¿…æ³¨æ„ä¸­é—´ä»¶çš„æ‰§è¡Œé¡ºåº!!!</span></span><br><span class="line"><span class="built_in">module</span>.exports = [</span><br><span class="line">  mdRoute,</span><br><span class="line">  mdRouterAllowed</span><br><span class="line">];</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><code>index.js</code>æ–‡ä»¶é‡Œé›†ä¸­äº†æ‰€æœ‰ç”¨åˆ°çš„ä¸­é—´ä»¶ï¼Œæ¥ä¸‹æ¥æ”¹é€ ä¸‹å¯åŠ¨æ–‡ä»¶ <code>app/index.js</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"><span class="keyword">const</span> compose = <span class="built_in">require</span>(<span class="string">&#x27;koa-compose&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> MD = <span class="built_in">require</span>(<span class="string">&#x27;./midllewares&#x27;</span>); <span class="comment">// å¼•å…¥æ‰€æœ‰çš„ä¸­é—´ä»¶</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> port = <span class="string">&#x27;3333&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> host = <span class="string">&#x27;0.0.0.0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">app.use(compose(MD)); <span class="comment">// composeæ¥æ”¶ä¸€ä¸ªä¸­é—´ä»¶æ•°ç»„, æŒ‰é¡ºåºåŒæ­¥æ‰§è¡Œï¼ï¼ï¼</span></span><br><span class="line"></span><br><span class="line">app.listen(port, host, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`API server listening on <span class="subst">$&#123;host&#125;</span>:<span class="subst">$&#123;port&#125;</span>`</span>)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><code>compose</code> æ˜¯ä¸€ä¸ªå·¥å…·å‡½æ•°ï¼Œ<code>Koa.js</code> çš„ä¸­é—´ä»¶é€šè¿‡è¿™ä¸ªå·¥å…·å‡½æ•°ç»„åˆåï¼Œ<strong>æŒ‰ <code>app.use()</code> çš„é¡ºåºåŒæ­¥æ‰§è¡Œ</strong>ï¼Œä¹Ÿå°±æ˜¯å½¢æˆäº† æ´‹è‘±åœˆ å¼çš„è°ƒç”¨ã€‚</p>
<p>å¼•å…¥<code> koa-bodyparser</code>ç»Ÿä¸€å¤„ç†è¯·æ±‚å‚æ•°ï¼Œ<strong>æ³¨æ„ï¼šbodyParser ä¸ºäº†å¤„ç†æ¯ä¸ª Request ä¸­çš„ä¿¡æ¯ï¼Œè¦æ”¾åˆ°è·¯ç”±å‰é¢å…ˆè®©ä»–å¤„ç†å†è¿›è·¯ç”±</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// midllewares/index.js</span></span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">&#x27;../router&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> koaBody = <span class="built_in">require</span>(<span class="string">&#x27;koa-bodyparser&#x27;</span>); <span class="comment">// bodyParser å°±æ˜¯ä¸ºäº†å¤„ç†æ¯ä¸ª Request ä¸­çš„ä¿¡æ¯ï¼Œè¦æ”¾åˆ°è·¯ç”±å‰é¢å…ˆè®©ä»–å¤„ç†å†è¿›è·¯ç”±</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è·¯ç”±å¤„ç†,router.allowedMethods()ç”¨åœ¨äº†è·¯ç”±åŒ¹é…router.routes()ä¹‹å,æ‰€ä»¥åœ¨å½“æ‰€æœ‰è·¯ç”±ä¸­é—´ä»¶æœ€åè°ƒç”¨.æ­¤æ—¶æ ¹æ®ctx.statusè®¾ç½®responseå“åº”å¤´</span></span><br><span class="line"><span class="keyword">const</span> mdRoute = router.routes();</span><br><span class="line"><span class="keyword">const</span> mdRouterAllowed = router.allowedMethods();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å‚æ•°è§£æ</span></span><br><span class="line"><span class="comment"> * https://github.com/koajs/bodyparser</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> mdKoaBody = koaBody(&#123;</span><br><span class="line">  enableTypes: [<span class="string">&#x27;json&#x27;</span>, <span class="string">&#x27;form&#x27;</span>, <span class="string">&#x27;text&#x27;</span>, <span class="string">&#x27;xml&#x27;</span>],</span><br><span class="line">  formLimit: <span class="string">&#x27;56kb&#x27;</span>,</span><br><span class="line">  jsonLimit: <span class="string">&#x27;1mb&#x27;</span>,</span><br><span class="line">  textLimit: <span class="string">&#x27;1mb&#x27;</span>,</span><br><span class="line">  xmlLimit: <span class="string">&#x27;1mb&#x27;</span>,</span><br><span class="line">  strict: <span class="literal">true</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ´‹è‘±æ¨¡å‹, åŠ¡å¿…æ³¨æ„ä¸­é—´ä»¶çš„æ‰§è¡Œé¡ºåº!!!</span></span><br><span class="line"><span class="built_in">module</span>.exports = [</span><br><span class="line">  mdKoaBody,</span><br><span class="line">  mdRoute,</span><br><span class="line">  mdRouterAllowed</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>postmanè¯·æ±‚æµ‹è¯•</p>
<p><img src="/Users/mac/Library/Application%20Support/typora-user-images/image-20210627102758998.png" alt="image-20210627102758998" loading="lazy"></p>
<p>è·å–<code>ctx.request.body</code>æˆåŠŸï¼</p>
<p>å¼•ç”¨<code>koa-bodyparser</code>æ–‡æ¡£çš„ä¸€å¥è¯ï¼Œå¯ä»¥çœ‹å‡ºæ¥å®ƒå¹¶ä¸æ”¯æŒäºŒè¿›åˆ¶æµæ¥è¿›è¡Œä¸Šä¼ ï¼Œå¹¶ä¸”å¸Œæœ›æˆ‘ä»¬ç”¨<code>co-busboy</code>æ¥è§£æ<code>multipart  format data</code></p>
<blockquote>
<p>Notice: this module donâ€™t support parsing multipart format data, please use <a target="_blank" rel="noopener" href="https://github.com/cojs/busboy">co-busboy</a> to parse multipart format data.</p>
</blockquote>
<p>æ›¿æ¢<code>koa-bodyparser</code>ä¸º<code>koa-body</code>ï¼Œ<code>koa-body</code> ä¸»è¦æ˜¯ä¸‹é¢ä¸¤ä¸ªä¾èµ–ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;co-body&quot;</span>: <span class="string">&quot;^5.1.1&quot;</span>,</span><br><span class="line"><span class="string">&quot;formidable&quot;</span>: <span class="string">&quot;^1.1.1&quot;</span></span><br></pre></td></tr></table></figure>
<p>å®˜æ–¹è¿™æ ·å¯¹å®ƒåšäº†ä»‹ç»</p>
<blockquote>
<p>A full-featured <a target="_blank" rel="noopener" href="https://github.com/koajs/koa"><code>koa</code></a> body parser middleware. Supports <code>multipart</code>, <code>urlencoded</code>, and <code>json</code> request bodies. Provides the same functionality as Expressâ€™s bodyParser - <a target="_blank" rel="noopener" href="https://github.com/expressjs/multer"><code>multer</code></a>.</p>
</blockquote>
<p>ä¿®æ”¹<code>app/midllewares/index.js</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; tempFilePath &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../config&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; checkDirExist &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../utils/file&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">&#x27;../router&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> koaBody = <span class="built_in">require</span>(<span class="string">&#x27;koa-body&#x27;</span>); <span class="comment">// koa-body å°±æ˜¯ä¸ºäº†å¤„ç†æ¯ä¸ª Request ä¸­çš„ä¿¡æ¯ï¼Œè¦æ”¾åˆ°è·¯ç”±å‰é¢å…ˆè®©ä»–å¤„ç†å†è¿›è·¯ç”±</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è·¯ç”±å¤„ç†,router.allowedMethods()ç”¨åœ¨äº†è·¯ç”±åŒ¹é…router.routes()ä¹‹å,æ‰€ä»¥åœ¨å½“æ‰€æœ‰è·¯ç”±ä¸­é—´ä»¶æœ€åè°ƒç”¨.æ­¤æ—¶æ ¹æ®ctx.statusè®¾ç½®responseå“åº”å¤´</span></span><br><span class="line"><span class="keyword">const</span> mdRoute = router.routes();</span><br><span class="line"><span class="keyword">const</span> mdRouterAllowed = router.allowedMethods();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å‚æ•°è§£æ</span></span><br><span class="line"><span class="comment"> * https://github.com/koajs/bodyparser</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> mdKoaBody = koaBody(&#123;</span><br><span class="line">  multipart: <span class="literal">true</span>, <span class="comment">// æ”¯æŒæ–‡ä»¶ä¸Šä¼ </span></span><br><span class="line">  <span class="comment">// encoding: &#x27;gzip&#x27;, // å¯ç”¨è¿™ä¸ªä¼šæŠ¥é”™</span></span><br><span class="line">  formidable: &#123;</span><br><span class="line">    uploadDir: tempFilePath, <span class="comment">// è®¾ç½®æ–‡ä»¶ä¸Šä¼ ç›®å½•</span></span><br><span class="line">    keepExtensions: <span class="literal">true</span>,    <span class="comment">// ä¿æŒæ–‡ä»¶çš„åç¼€</span></span><br><span class="line">    maxFieldsSize: <span class="number">200</span> * <span class="number">1024</span> * <span class="number">1024</span>, <span class="comment">// è®¾ç½®ä¸Šä¼ æ–‡ä»¶å¤§å°æœ€å¤§é™åˆ¶ï¼Œé»˜è®¤2M</span></span><br><span class="line">    onFileBegin: <span class="function">(<span class="params">name,file</span>) =&gt;</span> &#123; <span class="comment">// æ–‡ä»¶ä¸Šä¼ å‰çš„è®¾ç½®</span></span><br><span class="line">      <span class="comment">// æ£€æŸ¥æ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨å¦‚æœä¸å­˜åœ¨åˆ™æ–°å»ºæ–‡ä»¶å¤¹</span></span><br><span class="line">      checkDirExist(tempFilePath);</span><br><span class="line">      <span class="comment">// è·å–æ–‡ä»¶åç§°</span></span><br><span class="line">      <span class="keyword">const</span> fileName = file.name;</span><br><span class="line">      <span class="comment">// é‡æ–°è¦†ç›– file.path å±æ€§</span></span><br><span class="line">      file.path = <span class="string">`<span class="subst">$&#123;tempFilePath&#125;</span>/<span class="subst">$&#123;fileName&#125;</span>`</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    onError:<span class="function">(<span class="params">err</span>)=&gt;</span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(err);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ´‹è‘±æ¨¡å‹, åŠ¡å¿…æ³¨æ„ä¸­é—´ä»¶çš„æ‰§è¡Œé¡ºåº!!!</span></span><br><span class="line"><span class="built_in">module</span>.exports = [</span><br><span class="line">  mdKoaBody,</span><br><span class="line">  mdRoute,</span><br><span class="line">  mdRouterAllowed</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ï¼Œåˆ›å»ºäº†configå’Œutilsä¸¤ä¸ªæ–‡ä»¶å¤¹ï¼Œå„è‡ªç›®å½•åˆ†åˆ«ä¸ºï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627163251.png" alt="image-20210627163251606" loading="lazy"></p>
<p><code>config</code>ä¸­æ–‡ä»¶ç›®å‰åªé…ç½®äº†ä¸Šä¼ æ–‡ä»¶çš„ä¸´æ—¶è·¯å¾„ï¼Œåé¢è¿˜å¯ä»¥é…ç½®ä¸€äº›ä¸åŒç¯å¢ƒä¸‹çš„é…ç½®ç›¸å…³ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627163452.png" alt="image-20210627163452123" loading="lazy"></p>
<p><code>utils</code>æ–‡ä»¶å¤¹ä¸‹åˆ›å»ºäº†ä¸€ä¸ª<code>file.js</code>å·¥å…·æ–‡ä»¶å’Œ`index.jsç»Ÿä¸€å¯¼å‡ºæ–‡ä»¶ï¼Œä¸»è¦å¤„ç†å¯¹æ–‡ä»¶ç›¸å…³ï¼ˆè·¯å¾„ã€æ–‡ä»¶åç­‰ï¼‰çš„é€»è¾‘ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// utils/file.js</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUploadDirName</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">const</span> date = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">  <span class="keyword">let</span> month = <span class="built_in">Number</span>.parseInt(date.getMonth()) + <span class="number">1</span>;</span><br><span class="line">  month = month.toString().length &gt; <span class="number">1</span> ? month : <span class="string">`0<span class="subst">$&#123;month&#125;</span>`</span>;</span><br><span class="line">  <span class="keyword">const</span> dir = <span class="string">`<span class="subst">$&#123;date.getFullYear()&#125;</span><span class="subst">$&#123;month&#125;</span><span class="subst">$&#123;date.getDate()&#125;</span>`</span>;</span><br><span class="line">  <span class="keyword">return</span> dir;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºç›®å½•å¿…é¡»ä¸€å±‚ä¸€å±‚åˆ›å»º</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mkdir</span>(<span class="params">dirname</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(fs.existsSync(dirname))&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mkdir(path.dirname(dirname))) &#123;</span><br><span class="line">      fs.mkdirSync(dirname);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkDirExist</span>(<span class="params">p</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!fs.existsSync(p)) &#123;</span><br><span class="line">    mkdir(p)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUploadFileExt</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> idx = name.lastIndexOf(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">  <span class="keyword">return</span> name.substring(idx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUploadFileName</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> idx = name.lastIndexOf(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">  <span class="keyword">return</span> name.substring(<span class="number">0</span>, idx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  getUploadDirName,</span><br><span class="line">  checkDirExist,</span><br><span class="line">  getUploadFileExt,</span><br><span class="line">  getUploadFileName</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// utils/index.js</span></span><br><span class="line"><span class="keyword">const</span> file = <span class="built_in">require</span>(<span class="string">&#x27;./file&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  file</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>app/index.js</code>å¼•å…¥å…¨å±€å…¬å…±éƒ¨åˆ†ï¼ŒæŒ‚è½½åˆ°<code>app.context</code>ä¸Šä¸‹æ–‡ä¸­ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/index.js</span></span><br><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"><span class="keyword">const</span> compose = <span class="built_in">require</span>(<span class="string">&#x27;koa-compose&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> MD = <span class="built_in">require</span>(<span class="string">&#x27;./midllewares&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">&#x27;./config&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> utils = <span class="built_in">require</span>(<span class="string">&#x27;./utils&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> port = <span class="string">&#x27;3333&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> host = <span class="string">&#x27;0.0.0.0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">app.context.config = config;</span><br><span class="line">app.context.utils = utils;</span><br><span class="line"></span><br><span class="line">app.use(compose(MD));</span><br><span class="line"></span><br><span class="line">app.listen(port, host, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`API server listening on <span class="subst">$&#123;host&#125;</span>:<span class="subst">$&#123;port&#125;</span>`</span>)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•ä¸Šä¼ åŠŸèƒ½ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627164257.png" alt="image-20210627164254743" loading="lazy"></p>
<p><strong>æ³¨æ„ï¼šKoaBodyé…ç½®ä¸­ï¼ŒkeepExtensions: trueå¿…é¡»å¼€å¯ï¼Œå¦åˆ™ä¸Šä¼ ä¸ä¼šæˆåŠŸï¼</strong></p>
<p>æŸ¥çœ‹appç›®å½•ä¸‹ï¼Œç”Ÿæˆäº†æˆ‘ä»¬åˆšåˆšä¸Šä¼ çš„æ–‡ä»¶</p>
<p><img src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627164506.png" alt="image-20210627164506045" loading="lazy"></p>
<blockquote>
<p>åœ¨koa-body @4ä¸­ï¼Œæ§åˆ¶å°æ‰“å°æ–‡ä»¶ç›¸å…³ä¿¡æ¯ç”¨<code>ctx.request.files</code>ï¼Œä½ç‰ˆæœ¬ä½¿ç”¨<code>ctx.request.body.files</code></p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627164652.png" alt="image-20210627164652759" loading="lazy"></p>
<h3 id="ç»Ÿä¸€å“åº”ä½“-amp-é”™è¯¯å¤„ç†"><a href="#ç»Ÿä¸€å“åº”ä½“-amp-é”™è¯¯å¤„ç†" class="headerlink" title="ç»Ÿä¸€å“åº”ä½“ &amp; é”™è¯¯å¤„ç†"></a>ç»Ÿä¸€å“åº”ä½“ &amp; é”™è¯¯å¤„ç†</h3><p>ç»Ÿä¸€ æ ¼å¼å¤„ç†è¿”å›å“åº”ï¼Œå¯ä»¥å……åˆ†åˆ©ç”¨æ´‹è‘±æ¨¡å‹è¿›è¡Œä¼ é€’ï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸¤ä¸ªä¸­é—´ä»¶ï¼Œä¸€ä¸ªç»Ÿä¸€è¿”å›æ ¼å¼middlewareï¼Œä¸€ä¸ªé”™è¯¯å¤„ç†middlewareï¼Œåˆ†åˆ«å¦‚ä¸‹ï¼š</p>
<p>æ–‡ä»¶<code>app/midllewares/response.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> response = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    ctx.res.fail = <span class="function">(<span class="params">&#123; code, data, msg &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">      ctx.body = &#123;</span><br><span class="line">        code,</span><br><span class="line">        data,</span><br><span class="line">        msg,</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ctx.res.success = <span class="function"><span class="params">msg</span> =&gt;</span> &#123;</span><br><span class="line">      ctx.body = &#123;</span><br><span class="line">        code: <span class="number">0</span>,</span><br><span class="line">        data: ctx.body,</span><br><span class="line">        msg: msg || <span class="string">&#x27;success&#x27;</span>,</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> next();</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = response;</span><br></pre></td></tr></table></figure>
<p>æ–‡ä»¶ <code>app/middlewares/error.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> error = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">await</span> next();</span><br><span class="line">      <span class="keyword">if</span> (ctx.status === <span class="number">200</span>) &#123;</span><br><span class="line">        ctx.res.success();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      <span class="keyword">if</span> (err.code) &#123;</span><br><span class="line">        <span class="comment">// è‡ªå·±ä¸»åŠ¨æŠ›å‡ºçš„é”™è¯¯</span></span><br><span class="line">        ctx.res.fail(&#123; <span class="attr">code</span>: err.code, <span class="attr">msg</span>: err.message &#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ç¨‹åºè¿è¡Œæ—¶çš„é”™è¯¯</span></span><br><span class="line">        ctx.app.emit(<span class="string">&#x27;error&#x27;</span>, err, ctx);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = error;</span><br></pre></td></tr></table></figure>
<p><code>app/middlewares/index.js</code>å¼•ç”¨å®ƒä»¬ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; tempFilePath &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../config&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; checkDirExist &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../utils/file&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">&#x27;../router&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> koaBody = <span class="built_in">require</span>(<span class="string">&#x27;koa-body&#x27;</span>); <span class="comment">// koa-body å°±æ˜¯ä¸ºäº†å¤„ç†æ¯ä¸ª Request ä¸­çš„ä¿¡æ¯ï¼Œè¦æ”¾åˆ°è·¯ç”±å‰é¢å…ˆè®©ä»–å¤„ç†å†è¿›è·¯ç”±</span></span><br><span class="line"><span class="keyword">const</span> response = <span class="built_in">require</span>(<span class="string">&#x27;./response&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> error = <span class="built_in">require</span>(<span class="string">&#x27;./error&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·¯ç”±å¤„ç†,router.allowedMethods()ç”¨åœ¨äº†è·¯ç”±åŒ¹é…router.routes()ä¹‹å,æ‰€ä»¥åœ¨å½“æ‰€æœ‰è·¯ç”±ä¸­é—´ä»¶æœ€åè°ƒç”¨.æ­¤æ—¶æ ¹æ®ctx.statusè®¾ç½®responseå“åº”å¤´</span></span><br><span class="line"><span class="keyword">const</span> mdRoute = router.routes();</span><br><span class="line"><span class="keyword">const</span> mdRouterAllowed = router.allowedMethods();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å‚æ•°è§£æ</span></span><br><span class="line"><span class="comment"> * https://github.com/koajs/bodyparser</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> mdKoaBody = koaBody(&#123;</span><br><span class="line">  multipart: <span class="literal">true</span>, <span class="comment">// æ”¯æŒæ–‡ä»¶ä¸Šä¼ , å¿…é¡»è®¾ç½®ä¸ºtrue!!!</span></span><br><span class="line">  <span class="comment">// encoding: &#x27;gzip&#x27;, // å¯ç”¨è¿™ä¸ªä¼šæŠ¥é”™</span></span><br><span class="line">  formidable: &#123;</span><br><span class="line">    uploadDir: tempFilePath, <span class="comment">// è®¾ç½®æ–‡ä»¶ä¸Šä¼ ç›®å½•</span></span><br><span class="line">    keepExtensions: <span class="literal">true</span>,    <span class="comment">// ä¿æŒæ–‡ä»¶çš„åç¼€</span></span><br><span class="line">    maxFieldsSize: <span class="number">200</span> * <span class="number">1024</span> * <span class="number">1024</span>, <span class="comment">// è®¾ç½®ä¸Šä¼ æ–‡ä»¶å¤§å°æœ€å¤§é™åˆ¶ï¼Œé»˜è®¤2M</span></span><br><span class="line">    onFileBegin: <span class="function">(<span class="params">name,file</span>) =&gt;</span> &#123; <span class="comment">// æ–‡ä»¶ä¸Šä¼ å‰çš„è®¾ç½®</span></span><br><span class="line">      <span class="comment">// æ£€æŸ¥æ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨å¦‚æœä¸å­˜åœ¨åˆ™æ–°å»ºæ–‡ä»¶å¤¹</span></span><br><span class="line">      checkDirExist(tempFilePath);</span><br><span class="line">      <span class="comment">// è·å–æ–‡ä»¶åç§°</span></span><br><span class="line">      <span class="keyword">const</span> fileName = file.name;</span><br><span class="line">      <span class="comment">// é‡æ–°è¦†ç›– file.path å±æ€§</span></span><br><span class="line">      file.path = <span class="string">`<span class="subst">$&#123;tempFilePath&#125;</span>/<span class="subst">$&#123;fileName&#125;</span>`</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    onError:<span class="function">(<span class="params">err</span>)=&gt;</span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(err);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// ç»Ÿä¸€è¿”å›æ ¼å¼</span></span><br><span class="line"><span class="keyword">const</span> mdResHandler = response();</span><br><span class="line"><span class="comment">// é”™è¯¯å¤„ç†</span></span><br><span class="line"><span class="keyword">const</span> mdErrorHandler = error();</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ´‹è‘±æ¨¡å‹, åŠ¡å¿…æ³¨æ„ä¸­é—´ä»¶çš„æ‰§è¡Œé¡ºåº!!!</span></span><br><span class="line"><span class="built_in">module</span>.exports = [</span><br><span class="line">  mdKoaBody,</span><br><span class="line">  mdResHandler,</span><br><span class="line">  mdErrorHandler,</span><br><span class="line">  mdRoute,</span><br><span class="line">  mdRouterAllowed</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>å†æ¬¡å¼ºè°ƒä¸€éï¼Œapp.use()ä¸­ï¼Œä¸­é—´ä»¶æ‰§è¡Œæ˜¯æŒ‰ç»­åŒæ­¥æ‰§è¡Œï¼ŒmdResHandlerå®šä¹‰äº†ä¸¤ç§å¤„ç†é€šé“ï¼ˆæˆåŠŸå’Œå¤±è´¥ï¼‰ï¼ŒçœŸæ­£åˆ¤æ–­é€»è¾‘åœ¨error.jsä¸­é—´ä»¶ä¸­ï¼Œä¸€ç§æ˜¯ä¸šåŠ¡å‹é”™è¯¯ç ï¼Œéœ€è¦è¿”å›ç»™å‰ç«¯è¿›è¡Œå¤„ç†ï¼Œå¦ä¸€ç§æ˜¯æœåŠ¡ç«¯ä»£ç è¿è¡Œæ—¶æŠ¥é”™ï¼Œè¿™ç§é”™è¯¯ç±»å‹æˆ‘ä»¬éœ€è¦å‡ºå‘koaçš„é”™è¯¯å¤„ç†äº‹ä»¶å»å¤„ç†ã€‚error.jsä¸­åˆ¤æ–­å¤„ç†åéƒ½æ˜¯è°ƒç”¨mdResHandlerç»Ÿä¸€è¿”å›æ ¼å¼è¿”å›è¯·æ±‚å“åº”ã€‚é’ˆå¯¹æœåŠ¡ç«¯è¿è¡Œæ—¶ä»£ç é”™è¯¯ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åšå‡ºä¿®æ”¹ï¼Œåœ¨<code>app/index.js</code>ä¸­ä¿®æ”¹ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">app.on(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">err, ctx</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (ctx) &#123;</span><br><span class="line">    ctx.body = &#123;</span><br><span class="line">      code: <span class="number">9999</span>,</span><br><span class="line">      message: <span class="string">`ç¨‹åºè¿è¡Œæ—¶æŠ¥é”™ï¼š<span class="subst">$&#123;err.message&#125;</span>`</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>å®Œæˆåï¼Œæˆ‘ä»¬è¿˜æ˜¯åˆ©ç”¨ä¹‹å‰çš„<code>controller/ap/test.js</code>ä¸­echoçš„ä»£ç ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> echo = <span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  ctx.body = <span class="string">&#x27;è¿™æ˜¯ä¸€æ®µæ–‡å­—...&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å†æ¬¡è¯·æ±‚çœ‹çœ‹è·Ÿä¹‹å‰æœ‰ä»€ä¹ˆä¸ä¸€æ ·</p>
<p><img src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627171126.png" alt="image-20210627171126461" loading="lazy"></p>
<p>ç»“æœå¦‚é€¾æœŸè¿”å›ï¼Œå†è¿›è¡Œæ¨¡æ‹Ÿé”™è¯¯çš„è¿”å›ï¼Œä¿®æ”¹<code>test.js</code>ä¸‹çš„<code>echo</code>å‡½æ•°å¦‚ä¸‹ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test.js</span></span><br><span class="line"><span class="keyword">const</span> &#123; throwError &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../utils/handle&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> echo = <span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> data = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  ctx.assert(data, throwError(<span class="number">50002</span>, <span class="string">&#x27;tokenå¤±æ•ˆ!&#x27;</span>));</span><br><span class="line">  <span class="comment">// ä¸ä¼šå¾€ä¸‹æ‰§è¡Œäº†</span></span><br><span class="line">  ctx.body = <span class="string">&#x27;è¿™æ˜¯ä¸€æ®µæ–‡å­—...&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// utils/handle.js</span></span><br><span class="line"><span class="keyword">const</span> assert = <span class="built_in">require</span>(<span class="string">&#x27;assert&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> throwError = <span class="function">(<span class="params">code, message</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> err = <span class="keyword">new</span> <span class="built_in">Error</span>(message);</span><br><span class="line">  err.code = code;</span><br><span class="line">  <span class="keyword">throw</span> err;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  assert,</span><br><span class="line">  throwError</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>postmanå†æ¬¡è¯·æ±‚æµ‹è¯•ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627173550.png" alt="image-20210627173550538" loading="lazy"></p>
<p>ç»“æœå¦‚é¢„æœŸè¿”å›</p>
<p>ä¿®æ”¹<code>test.js</code>ä¸ºkoaè¿è¡Œæ—¶çš„ä»£ç é”™è¯¯ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> echo = <span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> data = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  data = <span class="string">&#x27;a&#x27;</span>; <span class="comment">// æ¨¡æ‹Ÿè¯­æ³•é”™è¯¯</span></span><br><span class="line">  ctx.body = <span class="string">&#x27;è¿™æ˜¯ä¸€æ®µæ–‡å­—...&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å†æ¬¡è¯·æ±‚ï¼Œå¾—åˆ°ç»“æœå¦‚ä¸‹ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627173801.png" alt="image-20210627173801715" loading="lazy"></p>
<p>è‡³æ­¤ï¼Œé”™è¯¯å¤„ç†æå®šäº†ï¼Œç»Ÿä¸€è¿”å›æ ¼å¼ä¹Ÿæå®šã€‚</p>
<h3 id="å‚æ•°æ ¡éªŒ"><a href="#å‚æ•°æ ¡éªŒ" class="headerlink" title="å‚æ•°æ ¡éªŒ"></a>å‚æ•°æ ¡éªŒ</h3><p>å‚æ•°æ ¡éªŒå¯ä»¥æå¤§çš„é¿å…ä¸Šè¯‰çš„ç¨‹åºè¿è¡Œæ—¶çš„é”™è¯¯ï¼Œåœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œæˆ‘ä»¬ä¹Ÿå°†å‚æ•°æ ¡éªŒæ”¾åœ¨<code>controller</code>é‡Œé¢å»å®Œæˆï¼Œ<code>test.js</code>æ–°å¢ä¸€ä¸ªä¸šåŠ¡å¤„ç†å‡½æ•°<code>print</code>ç”¨äºè¿”å›å‰ç«¯å§“åï¼Œæ‰“å°åœ¨é¡µé¢ä¸Š:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> print = <span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; name &#125; = ctx.request.query;</span><br><span class="line">  <span class="keyword">if</span> (!name) &#123;</span><br><span class="line">    ctx.utils.handle.assert(<span class="literal">false</span>, ctx.utils.handle.throwError(<span class="number">10001</span>, <span class="string">&#x27;å‚æ•°é”™è¯¯&#x27;</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  ctx.body = <span class="string">&#x27;æ‰“å°å§“å: &#x27;</span> + name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¯·æ±‚æµ‹è¯•ï¼Œæ­£å¸¸ä¼ å‚å¦‚ä¸‹ ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210628073806.png" alt="image-20210628073806022" loading="lazy"></p>
<p>ä¸ä¼ å‚æ•°ï¼Œè¿”å›é”™è¯¯çŠ¶æ€ç <code>10001</code>:</p>
<p><img src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210628073853.png" alt="image-20210628073852996" loading="lazy"></p>
<p>å¯ä»¥é¢„æ–™çš„æ˜¯ï¼Œéšç€ä¸šåŠ¡åœºæ™¯å¤æ‚åº¦çš„ä¸Šå‡ï¼Œcontrollerå±‚åé¢å¯¹äºå‚æ•°æ ¡éªŒçš„éƒ¨åˆ†ä»£ç ä¼šå˜å¾—è¶Šæ¥è¶Šåºå¤§ï¼Œæ‰€ä»¥è¿™éƒ¨åˆ†ä¸€å®šæ˜¯å¯ä»¥ä¼˜åŒ–çš„ï¼Œç¬¬ä¸‰æ–¹æ’ä»¶ <code>joi</code> å°±æ˜¯åº”å¯¹è¿™ç§åœºæ™¯ï¼Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ©æ­¤ä¸­é—´ä»¶å¸®åŠ©æˆ‘ä»¬å®Œæˆå‚æ•°æ ¡éªŒã€‚åœ¨ <code>app/middlewares/</code> ä¸‹æ·»åŠ  <code>validator.js</code> æ–‡ä»¶ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">paramSchema</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params">ctx, next</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> body = ctx.request.body;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> body === <span class="string">&#x27;string&#x27;</span> &amp;&amp; body.length) body = <span class="built_in">JSON</span>.parse(body);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;&#125;</span><br><span class="line">    <span class="keyword">const</span> paramMap = &#123;</span><br><span class="line">      router: ctx.request.params,</span><br><span class="line">      query: ctx.request.query,</span><br><span class="line">      body</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!paramSchema) <span class="keyword">return</span> next();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> schemaKeys = <span class="built_in">Object</span>.getOwnPropertyNames(paramSchema);</span><br><span class="line">    <span class="keyword">if</span> (!schemaKeys.length) <span class="keyword">return</span> next();</span><br><span class="line"></span><br><span class="line">    schemaKeys.some(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> validObj = paramMap[item];</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> validResult = paramSchema[item].validate(validObj, &#123;</span><br><span class="line">        allowUnknown: <span class="literal">true</span></span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (validResult.error) &#123;</span><br><span class="line">        ctx.assert(<span class="literal">false</span>, ctx.utils.handle.throwError(<span class="number">9998</span>, validResult.error.message));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">await</span> next();</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ä¿®æ”¹<code>app/router/index.js</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> koaRouter = <span class="built_in">require</span>(<span class="string">&#x27;koa-router&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> koaRouter();</span><br><span class="line"><span class="keyword">const</span> routes = <span class="built_in">require</span>(<span class="string">&#x27;./routes&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> validator = <span class="built_in">require</span>(<span class="string">&#x27;../midllewares/validator&#x27;</span>);</span><br><span class="line"></span><br><span class="line">routes.forEach(<span class="function"><span class="params">route</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; method, path, controller, valid &#125; = route;</span><br><span class="line">  router[method](path, validator(valid), controller);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>route</code>ä¸­å¤šè§£æ„äº†ä¸€ä¸ª<code>valid</code>æ¥ä½œä¸º<code>validator</code>çš„å‚æ•°ï¼Œ<code>app/router/routes.js</code>ä¸­<code>print</code>è·¯ç”±æ–°å¢ä¸€æ¡æ ¡éªŒè§„åˆ™ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  path: <span class="string">&#x27;/print&#x27;</span>,</span><br><span class="line">  method: <span class="string">&#x27;get&#x27;</span>,</span><br><span class="line">  valid: schTest.print,</span><br><span class="line">  controller: test.print</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>koa-router</code> å…è®¸æ·»åŠ å¤šä¸ªè·¯ç”±çº§ä¸­é—´ä»¶ï¼Œæˆ‘ä»¬å°†å‚æ•°æ ¡éªŒæ”¾åœ¨è¿™é‡Œå¤„ç†ã€‚éšååœ¨ <code>app</code>ç›®å½•ä¸‹æ–°å»ºç›®å½• <code>schema</code>ï¼Œç”¨æ¥å­˜æ”¾å‚æ•°æ ¡éªŒéƒ¨åˆ†çš„ä»£ç ï¼Œæ·»åŠ ä¸¤ä¸ªæ–‡ä»¶:</p>
<ol>
<li><p><code>app/schema/index.js</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> schTest = <span class="built_in">require</span>(<span class="string">&#x27;./test&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  schTest</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li>
<li><p><code>app/schema/test.js</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Joi = <span class="built_in">require</span>(<span class="string">&#x27;@hapi/joi&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> print = &#123;</span><br><span class="line">  query: Joi.object(&#123;</span><br><span class="line">    name: Joi.string().required(),</span><br><span class="line">    age: Joi.number().required()</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  list</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>æŠŠä¹‹å‰<code>app/controller/test.js</code>æ‰‹åŠ¨æ ¡éªŒéƒ¨åˆ†åˆ æ‰ ï¼Œæµ‹è¯•<code>joi</code>ä¸­é—´ä»¶æ˜¯å¦ç”Ÿæ•ˆï¼š</p>
</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> print = <span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; name &#125; = ctx.request.query;</span><br><span class="line">  ctx.body = <span class="string">&#x27;æ‰“å°å§“å: &#x27;</span> + name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¯·æ±‚æ¥å£æµ‹è¯•</p>
<p><img src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210628082630.png" alt="image-20210628082630673" loading="lazy"></p>
<p>åˆ°è¿™é‡Œï¼Œå‚æ•°æ ¡éªŒå°±ç®—æ•´åˆå®Œæˆï¼Œ<code>joi</code> æ›´å¤šçš„ä½¿ç”¨æ–¹æ³•è¯·<a target="_blank" rel="noopener" href="https://joi.dev/api/?v=17.4.0">æŸ¥çœ‹æ–‡æ¡£</a></p>
<h3 id="é…ç½®è·¨åŸŸ"><a href="#é…ç½®è·¨åŸŸ" class="headerlink" title="é…ç½®è·¨åŸŸ"></a>é…ç½®è·¨åŸŸ</h3><p>ä½¿ç”¨<code>@koa/cors</code>æ’ä»¶æ¥è¿›è¡Œè·¨åŸŸé…ç½®ï¼Œ<code>app/middlewares/index.js</code>æ·»åŠ é…ç½®ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...çœç•¥å…¶ä»–é…ç½®</span></span><br><span class="line"><span class="keyword">const</span> cors = <span class="built_in">require</span>(<span class="string">&#x27;@koa/cors&#x27;</span>); <span class="comment">// è·¨åŸŸé…ç½®</span></span><br><span class="line"><span class="comment">// è·¨åŸŸå¤„ç†</span></span><br><span class="line"><span class="keyword">const</span> mdCors = cors(&#123;</span><br><span class="line">  origin: <span class="string">&#x27;*&#x27;</span>,</span><br><span class="line">  credentials: <span class="literal">true</span>,</span><br><span class="line">  allowMethods: [ <span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;HEAD&#x27;</span>, <span class="string">&#x27;PUT&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;DELETE&#x27;</span>, <span class="string">&#x27;PATCH&#x27;</span> ]</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">module</span>.exports = [</span><br><span class="line">  mdKoaBody,</span><br><span class="line">  mdCors,</span><br><span class="line">  mdResHandler,</span><br><span class="line">  mdErrorHandler,</span><br><span class="line">  mdRoute,</span><br><span class="line">  mdRouterAllowed</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<h3 id="æ—¥å¿—"><a href="#æ—¥å¿—" class="headerlink" title="æ—¥å¿—"></a>æ—¥å¿—</h3><p>é‡‡ç”¨ <code>log4js</code> æ¥è®°å½•è¯·æ±‚æ—¥å¿—ï¼Œæ·»åŠ æ–‡ä»¶ <code>app/middlewares/log.js</code> :</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> log4js = <span class="built_in">require</span>(<span class="string">&#x27;log4js&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; outDir, flag, level &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../config&#x27;</span>).logConfig;</span><br><span class="line"></span><br><span class="line">log4js.configure(&#123;</span><br><span class="line">  appenders: &#123; <span class="attr">cheese</span>: &#123; <span class="attr">type</span>: <span class="string">&#x27;file&#x27;</span>, <span class="attr">filename</span>: <span class="string">`<span class="subst">$&#123;outDir&#125;</span>/receive.log`</span> &#125; &#125;,</span><br><span class="line">  categories: &#123; <span class="attr">default</span>: &#123; <span class="attr">appenders</span>: [ <span class="string">&#x27;cheese&#x27;</span> ], <span class="attr">level</span>: <span class="string">&#x27;info&#x27;</span> &#125; &#125;,</span><br><span class="line">  pm2: <span class="literal">true</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> logger = log4js.getLogger();</span><br><span class="line">logger.level = level;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; method, path, origin, query, body, headers, ip &#125; = ctx.request;</span><br><span class="line">    <span class="keyword">const</span> data = &#123;</span><br><span class="line">      method,</span><br><span class="line">      path,</span><br><span class="line">      origin,</span><br><span class="line">      query,</span><br><span class="line">      body,</span><br><span class="line">      ip,</span><br><span class="line">      headers</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">await</span> next();</span><br><span class="line">    <span class="keyword">if</span> (flag) &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; status, params &#125; = ctx;</span><br><span class="line">      data.status = status;</span><br><span class="line">      data.params = params;</span><br><span class="line">      data.result = ctx.body || <span class="string">&#x27;no content&#x27;</span>;</span><br><span class="line">      <span class="keyword">if</span> (ctx.body.code !== <span class="number">0</span>) &#123;</span><br><span class="line">        logger.error(<span class="built_in">JSON</span>.stringify(data));</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        logger.info(<span class="built_in">JSON</span>.stringify(data));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>app/middlewares/index.js</code> ä¸­å¼•å…¥ä¸Šé¢å†™çš„æ—¥å¿—ä¸­é—´ä»¶:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> log = <span class="built_in">require</span>(<span class="string">&#x27;./log&#x27;</span>); <span class="comment">// æ·»åŠ æ—¥å¿—</span></span><br><span class="line"><span class="comment">// ...çœç•¥å…¶ä»–ä»£ç </span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è®°å½•è¯·æ±‚æ—¥å¿—</span></span><br><span class="line"><span class="keyword">const</span> mdLogger = log();</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = [</span><br><span class="line">  mdKoaBody,</span><br><span class="line">  mdCors,</span><br><span class="line">  mdLogger,</span><br><span class="line">  mdResHandler,</span><br><span class="line">  mdErrorHandler,</span><br><span class="line">  mdRoute,</span><br><span class="line">  mdRouterAllowed</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>åˆ©ç”¨postmanè¯·æ±‚æ¥å£æµ‹è¯•æ•ˆæœï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627174730.png" alt="image-20210627174730031" loading="lazy"></p>
<p>æ‰“å¼€æ—¥å¿—æ–‡ä»¶ï¼ŒæŸ¥çœ‹æ—¥å¿— ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[2021-06-27T17:45:53.803] [INFO] default - &#123;&quot;method&quot;:&quot;GET&quot;,&quot;path&quot;:&quot;&#x2F;test1&quot;,&quot;origin&quot;:&quot;http:&#x2F;&#x2F;192.168.0.197:3333&quot;,&quot;query&quot;:&#123;&#125;,&quot;body&quot;:&#123;&#125;,&quot;ip&quot;:&quot;192.168.0.197&quot;,&quot;headers&quot;:&#123;&quot;host&quot;:&quot;192.168.0.197:3333&quot;,&quot;connection&quot;:&quot;keep-alive&quot;,&quot;cache-control&quot;:&quot;no-cache&quot;,&quot;user-agent&quot;:&quot;Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;91.0.4472.114 Safari&#x2F;537.36&quot;,&quot;postman-token&quot;:&quot;ae200806-a92b-00c4-5f2d-d5afdb7d717c&quot;,&quot;accept&quot;:&quot;*&#x2F;*&quot;,&quot;accept-encoding&quot;:&quot;gzip, deflate&quot;,&quot;accept-language&quot;:&quot;zh-CN,zh;q&#x3D;0.9,en;q&#x3D;0.8&quot;&#125;,&quot;status&quot;:200,&quot;params&quot;:&#123;&#125;,&quot;result&quot;:&#123;&quot;code&quot;:0,&quot;data&quot;:&quot;è¿™æ˜¯ä¸€æ®µæ–‡å­—...&quot;,&quot;msg&quot;:&quot;success&quot;&#125;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>åˆ°è¿™é‡Œï¼Œæ—¥å¿—æ¨¡å—å¼•ç”¨æˆåŠŸï¼</p>
<h3 id="æ•°æ®åº“æ“ä½œ"><a href="#æ•°æ®åº“æ“ä½œ" class="headerlink" title="æ•°æ®åº“æ“ä½œ"></a>æ•°æ®åº“æ“ä½œ</h3><p>åœ¨<code>app</code>ä¸‹å†æ–°å¢ä¸€ä¸ª <code>service</code> ç›®å½•ï¼Œ ä¹‹åçš„æ•°æ®åº“æ“ä½œæ”¾åœ¨ <code>service</code> ç›®å½•ä¸‹ï¼Œ<code>controller</code>ä¸“æ³¨ä¸šåŠ¡å¤„ç†ï¼Œ<code>service</code>ä¸“æ³¨æ•°æ®åº“çš„å¢åˆ æ”¹æŸ¥ç­‰äº‹åŠ¡æ“ä½œã€‚è¿˜å¯ä»¥æ·»åŠ ä¸€ä¸ª model ç›®å½•ï¼Œç”¨æ¥å®šä¹‰æ•°æ®åº“è¡¨ç»“æ„ï¼Œå…·ä½“çš„æ“ä½œå°†åœ¨ä¹‹åçš„<strong>koaåº”ç”¨å®æˆ˜</strong>ä¸­å…·ä½“å±•ç¤ºã€‚</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>åŸºæœ¬çš„koaå®æˆ˜å‹é¡¹ç›®åˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œä¼ä¸šçº§å¼€å‘ä¸­ï¼Œè¿˜ä¼šæœ‰æ›´å¤šçš„é—®é¢˜éœ€è¦è§£å†³ï¼ŒæœŸå¾…æ›´åŠ è´´è¿‘ä¼ä¸šçº§çš„å®æˆ˜é¡¹ç›®ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://github.com/cong1223/koa-demo.git">é¡¹ç›®è¿œç¨‹åœ°å€</a></p>
</div><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="æ‰“èµ" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-hand-coin-line"></use></svg></span><div id="reward-comment">æˆ‘å¾ˆå¯çˆ±ï¼Œè¯·ç»™æˆ‘é’±</div><div id="qr" style="display:none;"><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210131143747.jpeg"><img loading="lazy" src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210131143747.jpeg" alt="æ”¯ä»˜å®" title="æ”¯ä»˜å®"></a><div><span style="color:#00A3EE"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-alipay-line"></use></svg></span></div></div><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210131143944.jpeg"><img loading="lazy" src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210131143944.jpeg" alt="QQ æ”¯ä»˜" title="QQ æ”¯ä»˜"></a><div><span style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></span></div></div><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210131143746.jpeg"><img loading="lazy" src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210131143746.jpeg" alt="å¾®ä¿¡æ”¯ä»˜" title="å¾®ä¿¡æ”¯ä»˜"></a><div><span style="color:#2DC100"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-pay-line"></use></svg></span></div></div></div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>æœ¬æ–‡ä½œè€…ï¼š</strong>å°èªå¿™</li><li class="post-copyright-link"><strong>æœ¬æ–‡é“¾æ¥ï¼š</strong><a href="https://cong1223.github.io/2021/06/28/koa%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93/" title="koaå®è·µæ€»ç»“">https://cong1223.github.io/2021/06/28/koa%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93/</a></li><li class="post-copyright-license"><strong>ç‰ˆæƒå£°æ˜ï¼š</strong>æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é»˜è®¤é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a> è®¸å¯åè®®ã€‚</li></ul></section></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2021/07/20/%E3%80%90%E7%A0%81%E4%B8%8D%E5%81%9C%E9%A2%98-%E7%AE%97%E6%B3%95%E7%AF%87%E3%80%91%E4%BA%8C%E5%8F%89%E6%A0%91%E7%9A%84%E5%B1%82%E5%BA%8F%E9%81%8D%E5%8E%86/" rel="prev" title="ã€ç ä¸åœé¢˜-ç®—æ³•ç¯‡ã€‘äºŒå‰æ ‘çš„å±‚åºéå†"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text">ã€ç ä¸åœé¢˜-ç®—æ³•ç¯‡ã€‘äºŒå‰æ ‘çš„å±‚åºéå†</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2021/06/25/%E4%B8%80%E4%B8%AA%E5%9F%BA%E4%BA%8Evue%E7%9A%84%E5%9B%BE%E7%89%87%E8%A3%81%E5%89%AA%E5%92%8C%E5%8E%BB%E5%BA%95%E8%89%B2%E6%8F%92%E4%BB%B6/" rel="next" title="ä¸€ä¸ªåŸºäºvueçš„å›¾ç‰‡è£å‰ªå’Œå»åº•è‰²æ’ä»¶"><span class="post-nav-text">ä¸€ä¸ªåŸºäºvueçš„å›¾ç‰‡è£å‰ªå’Œå»åº•è‰²æ’ä»¶</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div><div id="comment"><div class="comment-tooltip text-center"><span>ç‚¹å‡»æŒ‰é’®è·³è½¬ GitHub Issues è¯„è®ºã€‚</span><br><span>è‹¥æ²¡æœ‰æœ¬æ–‡ Issueï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ Comment æ¨¡ç‰ˆæ–°å»ºã€‚</span><br><a class="hty-button hty-button--raised" id="github-issues" target="_blank" rel="noopener" href="https://github.com/cong1223/cong1223.github.io/issues?q=is:issue+koaå®è·µæ€»ç»“">GitHub Issues</a><a class="hty-button hty-button--raised" id="github-discussions" target="_blank" rel="noopener" href="https://github.com/cong1223/cong1223.github.io/discussions/new">GitHub Discussions</a></div><div id="disqus_thread"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/disqusjs@latest/dist/disqusjs.css"><script src="https://cdn.jsdelivr.net/npm/disqusjs@latest/dist/disqus.js"></script><script>const disqusjsConfig = {"enable":true,"shortname":"ghostwang-com"}
function loadDisqus() {
  const dsqjs = new DisqusJS(disqusjsConfig)
}</script><script src="/js/comments/disqus.js"></script></div></main><footer class="sidebar-translate" id="footer"><div class="beian"><a rel="noopener" href="https://beian.miit.gov.cn/" target="_blank">è‹ICPå¤‡17038157å·</a></div><div class="copyright"><span>&copy; 2021 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> å°èªå¿™</span></div></footer><a class="hty-icon-button" id="goUp" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" href="javascript:;" title="æœç´¢"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search-line"></use></svg></span></a><script>window.addEventListener("DOMContentLoaded", () => {
  // Handle and trigger popup window
  document.querySelector(".popup-trigger").addEventListener("click", () => {
    document.querySelector(".popup").classList.add("show");
    setTimeout(() => {
      document.querySelector(".search-input").focus();
    }, 100);
  });

  // Monitor main search box
  const onPopupClose = () => {
    document.querySelector(".popup").classList.remove("show");
  };

  document.querySelector(".popup-btn-close").addEventListener("click", () => {
    onPopupClose();
  });

  window.addEventListener("keyup", event => {
    if (event.key === "Escape") {
      onPopupClose();
    }
  });
});
</script><script defer src="https://cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script><script defer src="https://cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script><script defer src="/js/search/algolia-search.js"></script><div class="popup search-popup"><div class="search-header"><span class="popup-btn-close close-icon hty-icon-button"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-close-line"></use></svg></span></div><div class="search-input-container"></div><div class="algolia-results"><div id="algolia-stats"></div><div id="algolia-hits"></div><div class="algolia-pagination" id="algolia-pagination"></div></div></div></div></body></html>