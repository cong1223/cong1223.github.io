<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="小聪忙"><meta name="copyright" content="小聪忙"><meta name="generator" content="Hexo 5.3.0"><meta name="theme" content="hexo-theme-yun"><title>koa实践总结 | 聪忙的小站-Code &amp; Rock</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.1.22/dist/yun/yun-markdown.min.css"><script src="//at.alicdn.com/t/font_1140697_ed8vp4atwoj.js" async></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>document.addEventListener("DOMContentLoaded", () => {
  [".post-card",".post-content img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
});
</script><link rel="shortcut icon" type="image/svg+xml" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#0078E7"><link rel="alternate icon" href="/yun.ico"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><script id="yun-config">
    const Yun = window.Yun || {};
    window.CONFIG = {"hostname":"cong1223.github.io","root":"/","title":"聪忙的小站","version":"1.4.0","mode":"auto","copycode":true,"page":{"isPost":true},"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","say":{"api":"https://el-bot-api.vercel.app/api/words/young"},"algolia":{"appID":"FPFBIG0SN1","apiKey":"f75714621d5494f13edbe7a616932224","indexName":"hexo-blog","hits":{"per_page":8},"labels":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容: ${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},"fireworks":{"colors":["102, 167, 221","62, 131, 225","33, 78, 194"]}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/utils.js"></script><script src="/js/hexo-theme-yun.js"></script><script>(function(){
  var bp = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https') {
    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else {
    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})();</script><!-- Google Tag Manager --><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-M9KWR9L');</script><!-- End Google Tag Manager --><meta name="description" content="什么是koa？koa是Express的下一代基于Node.js的web框架。使用 koa 编写 web 应用，通过组合不同的 generator，可以免除重复繁琐的回调函数嵌套，并极大地提升常用错误处理效率。Koa 不在内核方法中绑定任何中间件，它仅仅提供了一个轻量优雅的函数库，使得编写 Web 应用和API变得得心应手。 Koa能干什么？主要用途  网站（比如cnode这样的论坛） api（三端">
<meta property="og:type" content="article">
<meta property="og:title" content="koa实践总结">
<meta property="og:url" content="https://cong1223.github.io/2021/06/28/koa%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93/index.html">
<meta property="og:site_name" content="聪忙的小站-Code &amp; Rock">
<meta property="og:description" content="什么是koa？koa是Express的下一代基于Node.js的web框架。使用 koa 编写 web 应用，通过组合不同的 generator，可以免除重复繁琐的回调函数嵌套，并极大地提升常用错误处理效率。Koa 不在内核方法中绑定任何中间件，它仅仅提供了一个轻量优雅的函数库，使得编写 Web 应用和API变得得心应手。 Koa能干什么？主要用途  网站（比如cnode这样的论坛） api（三端">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627083559.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627084008.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627085327.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627090757.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627092430.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627093721.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627102934.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627102601.png">
<meta property="og:image" content="https://cong1223.github.io/Users/mac/Library/Application%20Support/typora-user-images/image-20210627102758998.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627163251.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627163452.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627164257.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627164506.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627164652.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627171126.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627173550.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627173801.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210628073806.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210628073853.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210628082630.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627174730.png">
<meta property="article:published_time" content="2021-06-28T15:18:32.000Z">
<meta property="article:modified_time" content="2021-07-16T23:50:55.017Z">
<meta property="article:author" content="小聪忙">
<meta property="article:tag" content="koa2">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627083559.png"><script src="/js/ui/mode.js"></script></head><body><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="小聪忙"><img width="96" loading="lazy" src="/images/ghostwang.jpeg" alt="小聪忙"><span class="site-author-status" title="Looking for dawn.">🌑</span></a><div class="site-author-name"><a href="/about/">小聪忙</a></div><a class="site-name" href="/about/site.html">聪忙的小站-Code &amp; Rock</a><sub class="site-subtitle">记录分享前端领域技术博文</sub><div class="site-desciption"></div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="首页"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="归档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">56</span></a></div><div class="site-state-item"><a href="/categories/" title="分类"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">14</span></a></div><div class="site-state-item"><a href="/tags/" title="标签"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">60</span></a></div><a class="site-state-item hty-icon-button" href="/about/#comment" title="留言板"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-clipboard-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="/atom.xml" title="RSS" target="_blank" style="color:orange"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-rss-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://jq.qq.com/?_wv=1027&amp;k=g4dnBzs9" title="QQ 群 94500464" target="_blank" style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/cong1223" title="GitHub" target="_blank" style="color:#6e5494"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://weibo.com/5861177611" title="微博" target="_blank" style="color:#E6162D"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-weibo-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://music.163.com/#/user/home?id=436106908" title="网易云音乐" target="_blank" style="color:#C20C0C"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-netease-cloud-music-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://space.bilibili.com/94308826" title="哔哩哔哩" target="_blank" style="color:#FF8EB3"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-bilibili-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210131133736.png" title="微信公众号" target="_blank" style="color:#1AAD19"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-2-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="mailto:1215524451@qq.com" title="E-Mail" target="_blank" style="color:#8E71C1"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="我的小伙伴们" style="color:dodgerblue"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-genderless-line"></use></svg></a><a class="links-item hty-icon-button" href="/girls/" title="喜欢的女孩子" style="color:hotpink"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-women-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-contrast-2-line"></use></svg></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFkoa%EF%BC%9F"><span class="toc-number">1.</span> <span class="toc-text">什么是koa？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Koa%E8%83%BD%E5%B9%B2%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">2.</span> <span class="toc-text">Koa能干什么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA%E9%A1%B9%E7%9B%AE%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1"><span class="toc-number">3.</span> <span class="toc-text">搭建项目启动服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E5%A4%84%E7%90%86"><span class="toc-number">4.</span> <span class="toc-text">路由处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90"><span class="toc-number">5.</span> <span class="toc-text">参数解析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%9F%E4%B8%80%E5%93%8D%E5%BA%94%E4%BD%93-amp-%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="toc-number">6.</span> <span class="toc-text">统一响应体 &amp; 错误处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E6%A0%A1%E9%AA%8C"><span class="toc-number">7.</span> <span class="toc-text">参数校验</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%B7%A8%E5%9F%9F"><span class="toc-number">8.</span> <span class="toc-text">配置跨域</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A5%E5%BF%97"><span class="toc-number">9.</span> <span class="toc-text">日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C"><span class="toc-number">10.</span> <span class="toc-text">数据库操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">11.</span> <span class="toc-text">总结</span></a></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="post-block" itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://cong1223.github.io/2021/06/28/koa%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="小聪忙"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="聪忙的小站-Code &amp; Rock"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">koa实践总结</h1><div class="post-meta"><div class="post-time" style="display:block"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <time title="创建时间：2021-06-28 23:18:32" itemprop="dateCreated datePublished" datetime="2021-06-28T23:18:32+08:00">2021-06-28</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-2-line"></use></svg></span> <time title="修改时间：2021-07-17 07:50:55" itemprop="dateModified" datetime="2021-07-17T07:50:55+08:00">2021-07-17</time></div><span class="post-count"><span class="post-symbolcount"><span class="post-meta-item-icon" title="本文字数"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-file-word-line"></use></svg></span> <span title="本文字数">5.1k</span><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="阅读时长"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-timer-line"></use></svg></span> <span title="阅读时长">23m</span></span></span><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-line"></use></svg></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category" href="/categories/koa2/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">koa2</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag" href="/tags/koa2/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">koa2</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body" style="--smc-primary:#0078E7;"><h3 id="什么是koa？"><a href="#什么是koa？" class="headerlink" title="什么是koa？"></a>什么是koa？</h3><p>koa是Express的下一代基于Node.js的web框架。使用 koa 编写 web 应用，通过组合不同的 generator，可以免除重复繁琐的回调函数嵌套，并极大地提升常用错误处理效率。Koa 不在内核方法中绑定任何中间件，它仅仅提供了一个轻量优雅的函数库，使得编写 Web 应用和API变得得心应手。</p>
<h3 id="Koa能干什么？"><a href="#Koa能干什么？" class="headerlink" title="Koa能干什么？"></a>Koa能干什么？</h3><p>主要用途</p>
<ul>
<li>网站（比如cnode这样的论坛）</li>
<li>api（三端：pc、移动端、h5）</li>
<li>与其他模块搭配，比如和socket.io搭配写弹幕、im（即时聊天）等</li>
</ul>
<p>koa是微型web框架，但它也是个Node.js模块，也就是说我们也可以利用它做一些http相关的事儿。举例：实现类似于http-server这样的功能，在vue或react开发里，在爬虫里，利用路由触发爬虫任务等。比如在bin模块里，集成koa模块，启动个static-http-server这样的功能，都是非常容易的。</p>
<h3 id="搭建项目启动服务"><a href="#搭建项目启动服务" class="headerlink" title="搭建项目启动服务"></a>搭建项目启动服务</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 创建项目文件夹后初始化npm</span></span><br><span class="line">npm init</span><br><span class="line"><span class="comment">// 2. 安装koa环境</span></span><br><span class="line">npm install koa</span><br><span class="line"><span class="comment">// 3. 根目录下创建app文件夹作为我们源代码的目录</span></span><br><span class="line"><span class="comment">// 4. app下新建index.js作为入口文件</span></span><br></pre></td></tr></table></figure>
<p>生成目录结构如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627083559.png" loading="lazy"></p>
<p>编写<code>app/index.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"><span class="keyword">const</span> port = <span class="string">&#x27;3333&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> host = <span class="string">&#x27;0.0.0.0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  ctx.body = <span class="string">&#x27;Hello World&#x27;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(port, host, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`API server listening on <span class="subst">$&#123;host&#125;</span>:<span class="subst">$&#123;port&#125;</span>`</span>)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>根目录下运行<code>node app/index.js</code>，启动成功后控制台出现<code>API server listening on 0.0.0.0:3333</code>，打开浏览器访问<code>本机ip:3333</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627084008.png" alt="image-20210627084008790" loading="lazy"></p>
<h3 id="路由处理"><a href="#路由处理" class="headerlink" title="路由处理"></a>路由处理</h3><p><code>koa</code>中处理相应的路由返回对应的响应这一开发过程类似<code>java</code>中编写<code>controller</code>，<code>restful</code>风格的路由可以非常语义化的根据业务场景编写对应的处理函数，前端利用<code>axios</code>访问服务端找到对应的函数（路由名字）来获取对应想要的结果。</p>
<p>编写<code>app/index.js</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/index.js</span></span><br><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> port = <span class="string">&#x27;3333&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> host = <span class="string">&#x27;0.0.0.0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; path &#125; = ctx;</span><br><span class="line">  <span class="built_in">console</span>.log(path)</span><br><span class="line">  <span class="keyword">if</span> (path === <span class="string">&#x27;/test1&#x27;</span>) &#123;</span><br><span class="line">    ctx.body = <span class="string">&#x27;response for test1&#x27;</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (path === <span class="string">&#x27;/test2&#x27;</span>) &#123;</span><br><span class="line">    ctx.body = <span class="string">&#x27;response for test2&#x27;</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (path === <span class="string">&#x27;/test3&#x27;</span>) &#123;</span><br><span class="line">    ctx.body = <span class="string">&#x27;response for test3&#x27;</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    ctx.body = <span class="string">&#x27;Hello World&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(port, host, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`API server listening on <span class="subst">$&#123;host&#125;</span>:<span class="subst">$&#123;port&#125;</span>`</span>)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>注意：每次在koa中更新代码后想要生效必须重启koa服务</strong></p>
<p>这时，我们再访问试试：</p>
<p><img src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627085327.png" alt="image-20210627085327472" loading="lazy"></p>
<p>结果按我们预期返回了，这时我们先解决上诉的问题，如何热更新代码来帮助我们提高开发效率</p>
<ol>
<li><p>安装<code>nodemon</code></p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install nodemon</span><br><span class="line">npm i nodemon -g // 建议直接全局安装</span><br></pre></td></tr></table></figure>


</li>
</ol>
<ol start="2">
<li>修改<code>package.js</code></li>
</ol>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;scripts&quot;: &#123;</span><br><span class="line">  &quot;start&quot;: &quot;nodemon app/index.js&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>运行<code>npm run start</code>再次启动服务，这时修改代码后只需要刷新浏览器即可，不用重启node服务了!</p>
<p>可以预见的是：上面对路由的处理在实战中是不可行的，api逐渐增加后需要考虑到系统的可维护性，<code>koa-router</code>应运而生。</p>
<blockquote>
<p>koa-router: 集中处理URL的中间件，它负责处理URL映射，根据不同的URL调用不同的处理函数，这样，我们就能能专心为每个URL编写处理函数</p>
</blockquote>
<p>在 <code>app</code> 目录下新建 <code>router</code> 目录，如下所示:</p>
<p><img src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627090757.png" alt="image-20210627090757106" loading="lazy"></p>
<p>安装<code>koa-router</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install koa-router</span><br></pre></td></tr></table></figure>
<p>编写<code>app/router/index.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> koaRouter = <span class="built_in">require</span>(<span class="string">&#x27;koa-router&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> koaRouter();</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">&#x27;/test1&#x27;</span>, <span class="function"><span class="params">ctx</span>  =&gt;</span> &#123;</span><br><span class="line">  ctx.body = <span class="string">&#x27;response for test1&#x27;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">&#x27;/test2&#x27;</span>, <span class="function"><span class="params">ctx</span>  =&gt;</span> &#123;</span><br><span class="line">  ctx.body = <span class="string">&#x27;response for test2&#x27;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">&#x27;/test3&#x27;</span>, <span class="function"><span class="params">ctx</span>  =&gt;</span> &#123;</span><br><span class="line">  ctx.body = <span class="string">&#x27;response for test3&#x27;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>浏览器中再次访问测试，<code>http://192.168.0.197:3333/test3</code>，返回<code>response for test3</code>，返回结果与之前一致。再次细想一下，实际公司的业务场景中，<code>router/index.js</code>中可能一个处理函数就会非常庞大，因此，路由文件我们只需要关心具体的路由，它对应的处理函数可以单独提出来统一管理。我们可以把业务逻辑处理函数放到<code>controller</code>中，如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627092430.png" alt="image-20210627092430698" loading="lazy"></p>
<p>我们新增了三个文件：</p>
<ul>
<li><code>app/router/routes.js</code>    路由列表文件</li>
<li><code>app/contronllers/index.js</code>  业务处理统一导出</li>
<li><code>app/contronllers/test.js</code>  业务处理文件</li>
</ul>
<p>所有的业务逻辑代码放到controller中管理，如<code>app/contronllers/test.js</code>所示：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> echo = <span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  ctx.body = <span class="string">&#x27;这是一段文字...&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  echo</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>app/contronllers/index.js</code>统一入口，管理导出</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> test =  <span class="built_in">require</span>(<span class="string">&#x27;./test&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  test</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>app/router/routes.js</code>路由文件专心管理所有路由，无需维护对应业务逻辑代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; test &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../controllers&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">&#x27;test1&#x27;</span>,</span><br><span class="line">    method: <span class="string">&#x27;get&#x27;</span>,</span><br><span class="line">    controller: test.echo</span><br><span class="line">  &#125;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = routes;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>改造<code>app/router/index.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> koaRouter = <span class="built_in">require</span>(<span class="string">&#x27;koa-router&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> koaRouter();</span><br><span class="line"><span class="keyword">const</span> routes = <span class="built_in">require</span>(<span class="string">&#x27;./routes&#x27;</span>);</span><br><span class="line"></span><br><span class="line">routes.forEach(<span class="function"><span class="params">route</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; method, path, controller &#125; = route;</span><br><span class="line">  <span class="comment">//  router 第一个参数是 path， 后面跟上路由级中间件 controller（上面编写的路由处理函数）</span></span><br><span class="line">  router[method](path, controller);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure>
<p>打开浏览器访问<code>http://192.168.0.197:3333/test1</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627093721.png" alt="image-20210627093721213" loading="lazy"></p>
<p>结果如逾期正常返回，测试成功。</p>
<h3 id="参数解析"><a href="#参数解析" class="headerlink" title="参数解析"></a>参数解析</h3><p>测试完get请求后再请求一个post请求，path为<code>/postTest</code>，参数为<code>name: wangcong</code>，请求如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627102934.png" alt="image-20210627102933947" loading="lazy"></p>
<p>打印出<code>console.log(&#39;postTest&#39;, ctx)</code>如下，好像并没有找到我们传入的参数’name’，那如何获取到post的请求体呢？</p>
<p><img src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627102601.png" alt="image-20210627102601854" loading="lazy"></p>
<p><code>koa-bodyparser</code>: 对于POST请求的处理，koa-bodyparser中间件可以把koa2上下文的formData数据解析到ctx.request.body中</p>
<p>安装中间件之前，我们可以按照改造router的方式改造一下中间件的管理</p>
<p>新建<code>app/midllewares</code>目录，添加<code>index.js</code>文件统一管理所有中间件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">&#x27;../router&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 路由处理,router.allowedMethods()用在了路由匹配router.routes()之后,所以在当所有路由中间件最后调用.此时根据ctx.status设置response响应头</span></span><br><span class="line"><span class="keyword">const</span> mdRoute = router.routes();</span><br><span class="line"><span class="keyword">const</span> mdRouterAllowed = router.allowedMethods();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 导出数组是为后面使用koa-compose做准备，koa-compose支持传入数组，数组里的中间件一次同步执行</span></span><br><span class="line"><span class="comment">// 洋葱模型, 务必注意中间件的执行顺序!!!</span></span><br><span class="line"><span class="built_in">module</span>.exports = [</span><br><span class="line">  mdRoute,</span><br><span class="line">  mdRouterAllowed</span><br><span class="line">];</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><code>index.js</code>文件里集中了所有用到的中间件，接下来改造下启动文件 <code>app/index.js</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"><span class="keyword">const</span> compose = <span class="built_in">require</span>(<span class="string">&#x27;koa-compose&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> MD = <span class="built_in">require</span>(<span class="string">&#x27;./midllewares&#x27;</span>); <span class="comment">// 引入所有的中间件</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> port = <span class="string">&#x27;3333&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> host = <span class="string">&#x27;0.0.0.0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">app.use(compose(MD)); <span class="comment">// compose接收一个中间件数组, 按顺序同步执行！！！</span></span><br><span class="line"></span><br><span class="line">app.listen(port, host, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`API server listening on <span class="subst">$&#123;host&#125;</span>:<span class="subst">$&#123;port&#125;</span>`</span>)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><code>compose</code> 是一个工具函数，<code>Koa.js</code> 的中间件通过这个工具函数组合后，<strong>按 <code>app.use()</code> 的顺序同步执行</strong>，也就是形成了 洋葱圈 式的调用。</p>
<p>引入<code> koa-bodyparser</code>统一处理请求参数，<strong>注意：bodyParser 为了处理每个 Request 中的信息，要放到路由前面先让他处理再进路由</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// midllewares/index.js</span></span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">&#x27;../router&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> koaBody = <span class="built_in">require</span>(<span class="string">&#x27;koa-bodyparser&#x27;</span>); <span class="comment">// bodyParser 就是为了处理每个 Request 中的信息，要放到路由前面先让他处理再进路由</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 路由处理,router.allowedMethods()用在了路由匹配router.routes()之后,所以在当所有路由中间件最后调用.此时根据ctx.status设置response响应头</span></span><br><span class="line"><span class="keyword">const</span> mdRoute = router.routes();</span><br><span class="line"><span class="keyword">const</span> mdRouterAllowed = router.allowedMethods();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 参数解析</span></span><br><span class="line"><span class="comment"> * https://github.com/koajs/bodyparser</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> mdKoaBody = koaBody(&#123;</span><br><span class="line">  enableTypes: [<span class="string">&#x27;json&#x27;</span>, <span class="string">&#x27;form&#x27;</span>, <span class="string">&#x27;text&#x27;</span>, <span class="string">&#x27;xml&#x27;</span>],</span><br><span class="line">  formLimit: <span class="string">&#x27;56kb&#x27;</span>,</span><br><span class="line">  jsonLimit: <span class="string">&#x27;1mb&#x27;</span>,</span><br><span class="line">  textLimit: <span class="string">&#x27;1mb&#x27;</span>,</span><br><span class="line">  xmlLimit: <span class="string">&#x27;1mb&#x27;</span>,</span><br><span class="line">  strict: <span class="literal">true</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 洋葱模型, 务必注意中间件的执行顺序!!!</span></span><br><span class="line"><span class="built_in">module</span>.exports = [</span><br><span class="line">  mdKoaBody,</span><br><span class="line">  mdRoute,</span><br><span class="line">  mdRouterAllowed</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>postman请求测试</p>
<p><img src="/Users/mac/Library/Application%20Support/typora-user-images/image-20210627102758998.png" alt="image-20210627102758998" loading="lazy"></p>
<p>获取<code>ctx.request.body</code>成功！</p>
<p>引用<code>koa-bodyparser</code>文档的一句话，可以看出来它并不支持二进制流来进行上传，并且希望我们用<code>co-busboy</code>来解析<code>multipart  format data</code></p>
<blockquote>
<p>Notice: this module don’t support parsing multipart format data, please use <a target="_blank" rel="noopener" href="https://github.com/cojs/busboy">co-busboy</a> to parse multipart format data.</p>
</blockquote>
<p>替换<code>koa-bodyparser</code>为<code>koa-body</code>，<code>koa-body</code> 主要是下面两个依赖：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;co-body&quot;</span>: <span class="string">&quot;^5.1.1&quot;</span>,</span><br><span class="line"><span class="string">&quot;formidable&quot;</span>: <span class="string">&quot;^1.1.1&quot;</span></span><br></pre></td></tr></table></figure>
<p>官方这样对它做了介绍</p>
<blockquote>
<p>A full-featured <a target="_blank" rel="noopener" href="https://github.com/koajs/koa"><code>koa</code></a> body parser middleware. Supports <code>multipart</code>, <code>urlencoded</code>, and <code>json</code> request bodies. Provides the same functionality as Express’s bodyParser - <a target="_blank" rel="noopener" href="https://github.com/expressjs/multer"><code>multer</code></a>.</p>
</blockquote>
<p>修改<code>app/midllewares/index.js</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; tempFilePath &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../config&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; checkDirExist &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../utils/file&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">&#x27;../router&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> koaBody = <span class="built_in">require</span>(<span class="string">&#x27;koa-body&#x27;</span>); <span class="comment">// koa-body 就是为了处理每个 Request 中的信息，要放到路由前面先让他处理再进路由</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 路由处理,router.allowedMethods()用在了路由匹配router.routes()之后,所以在当所有路由中间件最后调用.此时根据ctx.status设置response响应头</span></span><br><span class="line"><span class="keyword">const</span> mdRoute = router.routes();</span><br><span class="line"><span class="keyword">const</span> mdRouterAllowed = router.allowedMethods();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 参数解析</span></span><br><span class="line"><span class="comment"> * https://github.com/koajs/bodyparser</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> mdKoaBody = koaBody(&#123;</span><br><span class="line">  multipart: <span class="literal">true</span>, <span class="comment">// 支持文件上传</span></span><br><span class="line">  <span class="comment">// encoding: &#x27;gzip&#x27;, // 启用这个会报错</span></span><br><span class="line">  formidable: &#123;</span><br><span class="line">    uploadDir: tempFilePath, <span class="comment">// 设置文件上传目录</span></span><br><span class="line">    keepExtensions: <span class="literal">true</span>,    <span class="comment">// 保持文件的后缀</span></span><br><span class="line">    maxFieldsSize: <span class="number">200</span> * <span class="number">1024</span> * <span class="number">1024</span>, <span class="comment">// 设置上传文件大小最大限制，默认2M</span></span><br><span class="line">    onFileBegin: <span class="function">(<span class="params">name,file</span>) =&gt;</span> &#123; <span class="comment">// 文件上传前的设置</span></span><br><span class="line">      <span class="comment">// 检查文件夹是否存在如果不存在则新建文件夹</span></span><br><span class="line">      checkDirExist(tempFilePath);</span><br><span class="line">      <span class="comment">// 获取文件名称</span></span><br><span class="line">      <span class="keyword">const</span> fileName = file.name;</span><br><span class="line">      <span class="comment">// 重新覆盖 file.path 属性</span></span><br><span class="line">      file.path = <span class="string">`<span class="subst">$&#123;tempFilePath&#125;</span>/<span class="subst">$&#123;fileName&#125;</span>`</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    onError:<span class="function">(<span class="params">err</span>)=&gt;</span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(err);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 洋葱模型, 务必注意中间件的执行顺序!!!</span></span><br><span class="line"><span class="built_in">module</span>.exports = [</span><br><span class="line">  mdKoaBody,</span><br><span class="line">  mdRoute,</span><br><span class="line">  mdRouterAllowed</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>其中，创建了config和utils两个文件夹，各自目录分别为：</p>
<p><img src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627163251.png" alt="image-20210627163251606" loading="lazy"></p>
<p><code>config</code>中文件目前只配置了上传文件的临时路径，后面还可以配置一些不同环境下的配置相关：</p>
<p><img src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627163452.png" alt="image-20210627163452123" loading="lazy"></p>
<p><code>utils</code>文件夹下创建了一个<code>file.js</code>工具文件和`index.js统一导出文件，主要处理对文件相关（路径、文件名等）的逻辑：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// utils/file.js</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUploadDirName</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">const</span> date = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">  <span class="keyword">let</span> month = <span class="built_in">Number</span>.parseInt(date.getMonth()) + <span class="number">1</span>;</span><br><span class="line">  month = month.toString().length &gt; <span class="number">1</span> ? month : <span class="string">`0<span class="subst">$&#123;month&#125;</span>`</span>;</span><br><span class="line">  <span class="keyword">const</span> dir = <span class="string">`<span class="subst">$&#123;date.getFullYear()&#125;</span><span class="subst">$&#123;month&#125;</span><span class="subst">$&#123;date.getDate()&#125;</span>`</span>;</span><br><span class="line">  <span class="keyword">return</span> dir;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建目录必须一层一层创建</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mkdir</span>(<span class="params">dirname</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(fs.existsSync(dirname))&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mkdir(path.dirname(dirname))) &#123;</span><br><span class="line">      fs.mkdirSync(dirname);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkDirExist</span>(<span class="params">p</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!fs.existsSync(p)) &#123;</span><br><span class="line">    mkdir(p)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUploadFileExt</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> idx = name.lastIndexOf(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">  <span class="keyword">return</span> name.substring(idx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUploadFileName</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> idx = name.lastIndexOf(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">  <span class="keyword">return</span> name.substring(<span class="number">0</span>, idx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  getUploadDirName,</span><br><span class="line">  checkDirExist,</span><br><span class="line">  getUploadFileExt,</span><br><span class="line">  getUploadFileName</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// utils/index.js</span></span><br><span class="line"><span class="keyword">const</span> file = <span class="built_in">require</span>(<span class="string">&#x27;./file&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  file</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>app/index.js</code>引入全局公共部分，挂载到<code>app.context</code>上下文中：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/index.js</span></span><br><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"><span class="keyword">const</span> compose = <span class="built_in">require</span>(<span class="string">&#x27;koa-compose&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> MD = <span class="built_in">require</span>(<span class="string">&#x27;./midllewares&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">&#x27;./config&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> utils = <span class="built_in">require</span>(<span class="string">&#x27;./utils&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> port = <span class="string">&#x27;3333&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> host = <span class="string">&#x27;0.0.0.0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">app.context.config = config;</span><br><span class="line">app.context.utils = utils;</span><br><span class="line"></span><br><span class="line">app.use(compose(MD));</span><br><span class="line"></span><br><span class="line">app.listen(port, host, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`API server listening on <span class="subst">$&#123;host&#125;</span>:<span class="subst">$&#123;port&#125;</span>`</span>)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>测试上传功能：</p>
<p><img src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627164257.png" alt="image-20210627164254743" loading="lazy"></p>
<p><strong>注意：KoaBody配置中，keepExtensions: true必须开启，否则上传不会成功！</strong></p>
<p>查看app目录下，生成了我们刚刚上传的文件</p>
<p><img src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627164506.png" alt="image-20210627164506045" loading="lazy"></p>
<blockquote>
<p>在koa-body @4中，控制台打印文件相关信息用<code>ctx.request.files</code>，低版本使用<code>ctx.request.body.files</code></p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627164652.png" alt="image-20210627164652759" loading="lazy"></p>
<h3 id="统一响应体-amp-错误处理"><a href="#统一响应体-amp-错误处理" class="headerlink" title="统一响应体 &amp; 错误处理"></a>统一响应体 &amp; 错误处理</h3><p>统一 格式处理返回响应，可以充分利用洋葱模型进行传递，我们可以编写两个中间件，一个统一返回格式middleware，一个错误处理middleware，分别如下：</p>
<p>文件<code>app/midllewares/response.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> response = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    ctx.res.fail = <span class="function">(<span class="params">&#123; code, data, msg &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">      ctx.body = &#123;</span><br><span class="line">        code,</span><br><span class="line">        data,</span><br><span class="line">        msg,</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ctx.res.success = <span class="function"><span class="params">msg</span> =&gt;</span> &#123;</span><br><span class="line">      ctx.body = &#123;</span><br><span class="line">        code: <span class="number">0</span>,</span><br><span class="line">        data: ctx.body,</span><br><span class="line">        msg: msg || <span class="string">&#x27;success&#x27;</span>,</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> next();</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = response;</span><br></pre></td></tr></table></figure>
<p>文件 <code>app/middlewares/error.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> error = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">await</span> next();</span><br><span class="line">      <span class="keyword">if</span> (ctx.status === <span class="number">200</span>) &#123;</span><br><span class="line">        ctx.res.success();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      <span class="keyword">if</span> (err.code) &#123;</span><br><span class="line">        <span class="comment">// 自己主动抛出的错误</span></span><br><span class="line">        ctx.res.fail(&#123; <span class="attr">code</span>: err.code, <span class="attr">msg</span>: err.message &#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 程序运行时的错误</span></span><br><span class="line">        ctx.app.emit(<span class="string">&#x27;error&#x27;</span>, err, ctx);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = error;</span><br></pre></td></tr></table></figure>
<p><code>app/middlewares/index.js</code>引用它们：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; tempFilePath &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../config&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; checkDirExist &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../utils/file&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">&#x27;../router&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> koaBody = <span class="built_in">require</span>(<span class="string">&#x27;koa-body&#x27;</span>); <span class="comment">// koa-body 就是为了处理每个 Request 中的信息，要放到路由前面先让他处理再进路由</span></span><br><span class="line"><span class="keyword">const</span> response = <span class="built_in">require</span>(<span class="string">&#x27;./response&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> error = <span class="built_in">require</span>(<span class="string">&#x27;./error&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 路由处理,router.allowedMethods()用在了路由匹配router.routes()之后,所以在当所有路由中间件最后调用.此时根据ctx.status设置response响应头</span></span><br><span class="line"><span class="keyword">const</span> mdRoute = router.routes();</span><br><span class="line"><span class="keyword">const</span> mdRouterAllowed = router.allowedMethods();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 参数解析</span></span><br><span class="line"><span class="comment"> * https://github.com/koajs/bodyparser</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> mdKoaBody = koaBody(&#123;</span><br><span class="line">  multipart: <span class="literal">true</span>, <span class="comment">// 支持文件上传, 必须设置为true!!!</span></span><br><span class="line">  <span class="comment">// encoding: &#x27;gzip&#x27;, // 启用这个会报错</span></span><br><span class="line">  formidable: &#123;</span><br><span class="line">    uploadDir: tempFilePath, <span class="comment">// 设置文件上传目录</span></span><br><span class="line">    keepExtensions: <span class="literal">true</span>,    <span class="comment">// 保持文件的后缀</span></span><br><span class="line">    maxFieldsSize: <span class="number">200</span> * <span class="number">1024</span> * <span class="number">1024</span>, <span class="comment">// 设置上传文件大小最大限制，默认2M</span></span><br><span class="line">    onFileBegin: <span class="function">(<span class="params">name,file</span>) =&gt;</span> &#123; <span class="comment">// 文件上传前的设置</span></span><br><span class="line">      <span class="comment">// 检查文件夹是否存在如果不存在则新建文件夹</span></span><br><span class="line">      checkDirExist(tempFilePath);</span><br><span class="line">      <span class="comment">// 获取文件名称</span></span><br><span class="line">      <span class="keyword">const</span> fileName = file.name;</span><br><span class="line">      <span class="comment">// 重新覆盖 file.path 属性</span></span><br><span class="line">      file.path = <span class="string">`<span class="subst">$&#123;tempFilePath&#125;</span>/<span class="subst">$&#123;fileName&#125;</span>`</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    onError:<span class="function">(<span class="params">err</span>)=&gt;</span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(err);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 统一返回格式</span></span><br><span class="line"><span class="keyword">const</span> mdResHandler = response();</span><br><span class="line"><span class="comment">// 错误处理</span></span><br><span class="line"><span class="keyword">const</span> mdErrorHandler = error();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 洋葱模型, 务必注意中间件的执行顺序!!!</span></span><br><span class="line"><span class="built_in">module</span>.exports = [</span><br><span class="line">  mdKoaBody,</span><br><span class="line">  mdResHandler,</span><br><span class="line">  mdErrorHandler,</span><br><span class="line">  mdRoute,</span><br><span class="line">  mdRouterAllowed</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>再次强调一遍，app.use()中，中间件执行是按续同步执行，mdResHandler定义了两种处理通道（成功和失败），真正判断逻辑在error.js中间件中，一种是业务型错误码，需要返回给前端进行处理，另一种是服务端代码运行时报错，这种错误类型我们需要出发koa的错误处理事件去处理。error.js中判断处理后都是调用mdResHandler统一返回格式返回请求响应。针对服务端运行时代码错误，我们还需要做出修改，在<code>app/index.js</code>中修改代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">app.on(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">err, ctx</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (ctx) &#123;</span><br><span class="line">    ctx.body = &#123;</span><br><span class="line">      code: <span class="number">9999</span>,</span><br><span class="line">      message: <span class="string">`程序运行时报错：<span class="subst">$&#123;err.message&#125;</span>`</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>完成后，我们还是利用之前的<code>controller/ap/test.js</code>中echo的代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> echo = <span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  ctx.body = <span class="string">&#x27;这是一段文字...&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再次请求看看跟之前有什么不一样</p>
<p><img src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627171126.png" alt="image-20210627171126461" loading="lazy"></p>
<p>结果如逾期返回，再进行模拟错误的返回，修改<code>test.js</code>下的<code>echo</code>函数如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test.js</span></span><br><span class="line"><span class="keyword">const</span> &#123; throwError &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../utils/handle&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> echo = <span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> data = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  ctx.assert(data, throwError(<span class="number">50002</span>, <span class="string">&#x27;token失效!&#x27;</span>));</span><br><span class="line">  <span class="comment">// 不会往下执行了</span></span><br><span class="line">  ctx.body = <span class="string">&#x27;这是一段文字...&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// utils/handle.js</span></span><br><span class="line"><span class="keyword">const</span> assert = <span class="built_in">require</span>(<span class="string">&#x27;assert&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> throwError = <span class="function">(<span class="params">code, message</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> err = <span class="keyword">new</span> <span class="built_in">Error</span>(message);</span><br><span class="line">  err.code = code;</span><br><span class="line">  <span class="keyword">throw</span> err;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  assert,</span><br><span class="line">  throwError</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>postman再次请求测试：</p>
<p><img src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627173550.png" alt="image-20210627173550538" loading="lazy"></p>
<p>结果如预期返回</p>
<p>修改<code>test.js</code>为koa运行时的代码错误：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> echo = <span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> data = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  data = <span class="string">&#x27;a&#x27;</span>; <span class="comment">// 模拟语法错误</span></span><br><span class="line">  ctx.body = <span class="string">&#x27;这是一段文字...&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再次请求，得到结果如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627173801.png" alt="image-20210627173801715" loading="lazy"></p>
<p>至此，错误处理搞定了，统一返回格式也搞定。</p>
<h3 id="参数校验"><a href="#参数校验" class="headerlink" title="参数校验"></a>参数校验</h3><p>参数校验可以极大的避免上诉的程序运行时的错误，在这个例子里，我们也将参数校验放在<code>controller</code>里面去完成，<code>test.js</code>新增一个业务处理函数<code>print</code>用于返回前端姓名，打印在页面上:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> print = <span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; name &#125; = ctx.request.query;</span><br><span class="line">  <span class="keyword">if</span> (!name) &#123;</span><br><span class="line">    ctx.utils.handle.assert(<span class="literal">false</span>, ctx.utils.handle.throwError(<span class="number">10001</span>, <span class="string">&#x27;参数错误&#x27;</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  ctx.body = <span class="string">&#x27;打印姓名: &#x27;</span> + name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>请求测试，正常传参如下 ：</p>
<p><img src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210628073806.png" alt="image-20210628073806022" loading="lazy"></p>
<p>不传参数，返回错误状态码<code>10001</code>:</p>
<p><img src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210628073853.png" alt="image-20210628073852996" loading="lazy"></p>
<p>可以预料的是，随着业务场景复杂度的上升，controller层后面对于参数校验的部分代码会变得越来越庞大，所以这部分一定是可以优化的，第三方插件 <code>joi</code> 就是应对这种场景，我们可以借助此中间件帮助我们完成参数校验。在 <code>app/middlewares/</code> 下添加 <code>validator.js</code> 文件：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">paramSchema</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params">ctx, next</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> body = ctx.request.body;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> body === <span class="string">&#x27;string&#x27;</span> &amp;&amp; body.length) body = <span class="built_in">JSON</span>.parse(body);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;&#125;</span><br><span class="line">    <span class="keyword">const</span> paramMap = &#123;</span><br><span class="line">      router: ctx.request.params,</span><br><span class="line">      query: ctx.request.query,</span><br><span class="line">      body</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!paramSchema) <span class="keyword">return</span> next();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> schemaKeys = <span class="built_in">Object</span>.getOwnPropertyNames(paramSchema);</span><br><span class="line">    <span class="keyword">if</span> (!schemaKeys.length) <span class="keyword">return</span> next();</span><br><span class="line"></span><br><span class="line">    schemaKeys.some(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> validObj = paramMap[item];</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> validResult = paramSchema[item].validate(validObj, &#123;</span><br><span class="line">        allowUnknown: <span class="literal">true</span></span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (validResult.error) &#123;</span><br><span class="line">        ctx.assert(<span class="literal">false</span>, ctx.utils.handle.throwError(<span class="number">9998</span>, validResult.error.message));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">await</span> next();</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>修改<code>app/router/index.js</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> koaRouter = <span class="built_in">require</span>(<span class="string">&#x27;koa-router&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> koaRouter();</span><br><span class="line"><span class="keyword">const</span> routes = <span class="built_in">require</span>(<span class="string">&#x27;./routes&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> validator = <span class="built_in">require</span>(<span class="string">&#x27;../midllewares/validator&#x27;</span>);</span><br><span class="line"></span><br><span class="line">routes.forEach(<span class="function"><span class="params">route</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; method, path, controller, valid &#125; = route;</span><br><span class="line">  router[method](path, validator(valid), controller);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure>
<p>可以看到，<code>route</code>中多解构了一个<code>valid</code>来作为<code>validator</code>的参数，<code>app/router/routes.js</code>中<code>print</code>路由新增一条校验规则，如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  path: <span class="string">&#x27;/print&#x27;</span>,</span><br><span class="line">  method: <span class="string">&#x27;get&#x27;</span>,</span><br><span class="line">  valid: schTest.print,</span><br><span class="line">  controller: test.print</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>koa-router</code> 允许添加多个路由级中间件，我们将参数校验放在这里处理。随后在 <code>app</code>目录下新建目录 <code>schema</code>，用来存放参数校验部分的代码，添加两个文件:</p>
<ol>
<li><p><code>app/schema/index.js</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> schTest = <span class="built_in">require</span>(<span class="string">&#x27;./test&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  schTest</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li>
<li><p><code>app/schema/test.js</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Joi = <span class="built_in">require</span>(<span class="string">&#x27;@hapi/joi&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> print = &#123;</span><br><span class="line">  query: Joi.object(&#123;</span><br><span class="line">    name: Joi.string().required(),</span><br><span class="line">    age: Joi.number().required()</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  list</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>把之前<code>app/controller/test.js</code>手动校验部分删掉 ，测试<code>joi</code>中间件是否生效：</p>
</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> print = <span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; name &#125; = ctx.request.query;</span><br><span class="line">  ctx.body = <span class="string">&#x27;打印姓名: &#x27;</span> + name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>请求接口测试</p>
<p><img src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210628082630.png" alt="image-20210628082630673" loading="lazy"></p>
<p>到这里，参数校验就算整合完成，<code>joi</code> 更多的使用方法请<a target="_blank" rel="noopener" href="https://joi.dev/api/?v=17.4.0">查看文档</a></p>
<h3 id="配置跨域"><a href="#配置跨域" class="headerlink" title="配置跨域"></a>配置跨域</h3><p>使用<code>@koa/cors</code>插件来进行跨域配置，<code>app/middlewares/index.js</code>添加配置，如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...省略其他配置</span></span><br><span class="line"><span class="keyword">const</span> cors = <span class="built_in">require</span>(<span class="string">&#x27;@koa/cors&#x27;</span>); <span class="comment">// 跨域配置</span></span><br><span class="line"><span class="comment">// 跨域处理</span></span><br><span class="line"><span class="keyword">const</span> mdCors = cors(&#123;</span><br><span class="line">  origin: <span class="string">&#x27;*&#x27;</span>,</span><br><span class="line">  credentials: <span class="literal">true</span>,</span><br><span class="line">  allowMethods: [ <span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;HEAD&#x27;</span>, <span class="string">&#x27;PUT&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;DELETE&#x27;</span>, <span class="string">&#x27;PATCH&#x27;</span> ]</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">module</span>.exports = [</span><br><span class="line">  mdKoaBody,</span><br><span class="line">  mdCors,</span><br><span class="line">  mdResHandler,</span><br><span class="line">  mdErrorHandler,</span><br><span class="line">  mdRoute,</span><br><span class="line">  mdRouterAllowed</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<h3 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h3><p>采用 <code>log4js</code> 来记录请求日志，添加文件 <code>app/middlewares/log.js</code> :</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> log4js = <span class="built_in">require</span>(<span class="string">&#x27;log4js&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; outDir, flag, level &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../config&#x27;</span>).logConfig;</span><br><span class="line"></span><br><span class="line">log4js.configure(&#123;</span><br><span class="line">  appenders: &#123; <span class="attr">cheese</span>: &#123; <span class="attr">type</span>: <span class="string">&#x27;file&#x27;</span>, <span class="attr">filename</span>: <span class="string">`<span class="subst">$&#123;outDir&#125;</span>/receive.log`</span> &#125; &#125;,</span><br><span class="line">  categories: &#123; <span class="attr">default</span>: &#123; <span class="attr">appenders</span>: [ <span class="string">&#x27;cheese&#x27;</span> ], <span class="attr">level</span>: <span class="string">&#x27;info&#x27;</span> &#125; &#125;,</span><br><span class="line">  pm2: <span class="literal">true</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> logger = log4js.getLogger();</span><br><span class="line">logger.level = level;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; method, path, origin, query, body, headers, ip &#125; = ctx.request;</span><br><span class="line">    <span class="keyword">const</span> data = &#123;</span><br><span class="line">      method,</span><br><span class="line">      path,</span><br><span class="line">      origin,</span><br><span class="line">      query,</span><br><span class="line">      body,</span><br><span class="line">      ip,</span><br><span class="line">      headers</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">await</span> next();</span><br><span class="line">    <span class="keyword">if</span> (flag) &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; status, params &#125; = ctx;</span><br><span class="line">      data.status = status;</span><br><span class="line">      data.params = params;</span><br><span class="line">      data.result = ctx.body || <span class="string">&#x27;no content&#x27;</span>;</span><br><span class="line">      <span class="keyword">if</span> (ctx.body.code !== <span class="number">0</span>) &#123;</span><br><span class="line">        logger.error(<span class="built_in">JSON</span>.stringify(data));</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        logger.info(<span class="built_in">JSON</span>.stringify(data));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在 <code>app/middlewares/index.js</code> 中引入上面写的日志中间件:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> log = <span class="built_in">require</span>(<span class="string">&#x27;./log&#x27;</span>); <span class="comment">// 添加日志</span></span><br><span class="line"><span class="comment">// ...省略其他代码</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 记录请求日志</span></span><br><span class="line"><span class="keyword">const</span> mdLogger = log();</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = [</span><br><span class="line">  mdKoaBody,</span><br><span class="line">  mdCors,</span><br><span class="line">  mdLogger,</span><br><span class="line">  mdResHandler,</span><br><span class="line">  mdErrorHandler,</span><br><span class="line">  mdRoute,</span><br><span class="line">  mdRouterAllowed</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>利用postman请求接口测试效果：</p>
<p><img src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210627174730.png" alt="image-20210627174730031" loading="lazy"></p>
<p>打开日志文件，查看日志 ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[2021-06-27T17:45:53.803] [INFO] default - &#123;&quot;method&quot;:&quot;GET&quot;,&quot;path&quot;:&quot;&#x2F;test1&quot;,&quot;origin&quot;:&quot;http:&#x2F;&#x2F;192.168.0.197:3333&quot;,&quot;query&quot;:&#123;&#125;,&quot;body&quot;:&#123;&#125;,&quot;ip&quot;:&quot;192.168.0.197&quot;,&quot;headers&quot;:&#123;&quot;host&quot;:&quot;192.168.0.197:3333&quot;,&quot;connection&quot;:&quot;keep-alive&quot;,&quot;cache-control&quot;:&quot;no-cache&quot;,&quot;user-agent&quot;:&quot;Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;91.0.4472.114 Safari&#x2F;537.36&quot;,&quot;postman-token&quot;:&quot;ae200806-a92b-00c4-5f2d-d5afdb7d717c&quot;,&quot;accept&quot;:&quot;*&#x2F;*&quot;,&quot;accept-encoding&quot;:&quot;gzip, deflate&quot;,&quot;accept-language&quot;:&quot;zh-CN,zh;q&#x3D;0.9,en;q&#x3D;0.8&quot;&#125;,&quot;status&quot;:200,&quot;params&quot;:&#123;&#125;,&quot;result&quot;:&#123;&quot;code&quot;:0,&quot;data&quot;:&quot;这是一段文字...&quot;,&quot;msg&quot;:&quot;success&quot;&#125;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>到这里，日志模块引用成功！</p>
<h3 id="数据库操作"><a href="#数据库操作" class="headerlink" title="数据库操作"></a>数据库操作</h3><p>在<code>app</code>下再新增一个 <code>service</code> 目录， 之后的数据库操作放在 <code>service</code> 目录下，<code>controller</code>专注业务处理，<code>service</code>专注数据库的增删改查等事务操作。还可以添加一个 model 目录，用来定义数据库表结构，具体的操作将在之后的<strong>koa应用实战</strong>中具体展示。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>基本的koa实战型项目到这里就结束了，企业级开发中，还会有更多的问题需要解决，期待更加贴近企业级的实战项目。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/cong1223/koa-demo.git">项目远程地址</a></p>
</div><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="打赏" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-hand-coin-line"></use></svg></span><div id="reward-comment">我很可爱，请给我钱</div><div id="qr" style="display:none;"><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210131143747.jpeg"><img loading="lazy" src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210131143747.jpeg" alt="支付宝" title="支付宝"></a><div><span style="color:#00A3EE"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-alipay-line"></use></svg></span></div></div><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210131143944.jpeg"><img loading="lazy" src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210131143944.jpeg" alt="QQ 支付" title="QQ 支付"></a><div><span style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></span></div></div><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210131143746.jpeg"><img loading="lazy" src="https://cdn.jsdelivr.net/gh/cong1223/cloudimg@master/img/20210131143746.jpeg" alt="微信支付" title="微信支付"></a><div><span style="color:#2DC100"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-pay-line"></use></svg></span></div></div></div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>小聪忙</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="https://cong1223.github.io/2021/06/28/koa%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93/" title="koa实践总结">https://cong1223.github.io/2021/06/28/koa%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a> 许可协议。</li></ul></section></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2021/07/20/%E3%80%90%E7%A0%81%E4%B8%8D%E5%81%9C%E9%A2%98-%E7%AE%97%E6%B3%95%E7%AF%87%E3%80%91%E4%BA%8C%E5%8F%89%E6%A0%91%E7%9A%84%E5%B1%82%E5%BA%8F%E9%81%8D%E5%8E%86/" rel="prev" title="【码不停题-算法篇】二叉树的层序遍历"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text">【码不停题-算法篇】二叉树的层序遍历</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2021/06/25/%E4%B8%80%E4%B8%AA%E5%9F%BA%E4%BA%8Evue%E7%9A%84%E5%9B%BE%E7%89%87%E8%A3%81%E5%89%AA%E5%92%8C%E5%8E%BB%E5%BA%95%E8%89%B2%E6%8F%92%E4%BB%B6/" rel="next" title="一个基于vue的图片裁剪和去底色插件"><span class="post-nav-text">一个基于vue的图片裁剪和去底色插件</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div><div id="comment"><div class="comment-tooltip text-center"><span>点击按钮跳转 GitHub Issues 评论。</span><br><span>若没有本文 Issue，您可以使用 Comment 模版新建。</span><br><a class="hty-button hty-button--raised" id="github-issues" target="_blank" rel="noopener" href="https://github.com/cong1223/cong1223.github.io/issues?q=is:issue+koa实践总结">GitHub Issues</a><a class="hty-button hty-button--raised" id="github-discussions" target="_blank" rel="noopener" href="https://github.com/cong1223/cong1223.github.io/discussions/new">GitHub Discussions</a></div><div id="disqus_thread"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/disqusjs@latest/dist/disqusjs.css"><script src="https://cdn.jsdelivr.net/npm/disqusjs@latest/dist/disqus.js"></script><script>const disqusjsConfig = {"enable":true,"shortname":"ghostwang-com"}
function loadDisqus() {
  const dsqjs = new DisqusJS(disqusjsConfig)
}</script><script src="/js/comments/disqus.js"></script></div></main><footer class="sidebar-translate" id="footer"><div class="beian"><a rel="noopener" href="https://beian.miit.gov.cn/" target="_blank">苏ICP备17038157号</a></div><div class="copyright"><span>&copy; 2021 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> 小聪忙</span></div></footer><a class="hty-icon-button" id="goUp" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" href="javascript:;" title="搜索"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search-line"></use></svg></span></a><script>window.addEventListener("DOMContentLoaded", () => {
  // Handle and trigger popup window
  document.querySelector(".popup-trigger").addEventListener("click", () => {
    document.querySelector(".popup").classList.add("show");
    setTimeout(() => {
      document.querySelector(".search-input").focus();
    }, 100);
  });

  // Monitor main search box
  const onPopupClose = () => {
    document.querySelector(".popup").classList.remove("show");
  };

  document.querySelector(".popup-btn-close").addEventListener("click", () => {
    onPopupClose();
  });

  window.addEventListener("keyup", event => {
    if (event.key === "Escape") {
      onPopupClose();
    }
  });
});
</script><script defer src="https://cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script><script defer src="https://cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script><script defer src="/js/search/algolia-search.js"></script><div class="popup search-popup"><div class="search-header"><span class="popup-btn-close close-icon hty-icon-button"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-close-line"></use></svg></span></div><div class="search-input-container"></div><div class="algolia-results"><div id="algolia-stats"></div><div id="algolia-hits"></div><div class="algolia-pagination" id="algolia-pagination"></div></div></div></div></body></html>